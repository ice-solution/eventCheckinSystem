<%- include ("components/header") %>
<%- include ("components/menu", {eventId: eventId }) %>
<link rel="stylesheet" href="/admin/assets/css/cs-skin-elastic.css">
<link rel="stylesheet" href="/admin/assets/css/style.css">
<div id="right-panel" class="right-panel">
    <%- include ("components/rightpanel_header") %>
    <div class="content">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <strong class="card-title">創建 SMS 模板 (Create SMS Template)</strong>
                        </div>
                        <div class="card-body">
                            <form id="smsTemplateForm">
                                <div class="form-group">
                                    <label for="type">SMS 類型 (SMS Type)</label>
                                    <select class="form-control" id="type" required>
                                        <option value="welcome">歡迎 (Welcome)</option>
                                        <option value="confirmation">確認 (Confirmation)</option>
                                        <option value="reminder">提醒 (Reminder)</option>
                                        <option value="thankYou">感謝 (Thank You)</option>
                                        <option value="invitation">邀請 (Invitation)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="content">SMS 內容 (SMS Content)</label>
                                    <textarea class="form-control" id="content" rows="10" required placeholder="輸入 SMS 內容..."></textarea>
                                    <small class="form-text text-muted">
                                        <strong>可用變數 (Available variables):</strong><br>
                                        基本：{{user.name}}, {{user.email}}, {{user.company}}, {{user.phone}}, {{user.phone_code}}, {{user.table}}, {{user.role}}<br>
                                        <% if (formConfig && formConfig.sections) { 
                                            const formFields = [];
                                            formConfig.sections.forEach(s => { if (s.visible && s.fields) s.fields.forEach(f => { if (f.visible) formFields.push('{{user.' + f.fieldName + '}}'); }); });
                                            if (formFields.length) { %><br>表單欄位（FormConfig）：<%= formFields.join(', ') %><% } %>
                                        <% } %>
                                        <br>活動/連結：{{event.name}}, {{loginUrl}}, {{confirmUrl}}, {{qrCodeUrl}}
                                    </small>
                                </div>
                                <div class="form-group">
                                    <div class="alert alert-info">
                                        <strong>範例 (Example):</strong><br>
                                        歡迎 {{user.name}} 參加 {{event.name}}！您的登入連結：{{loginUrl}}
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">保存 (Save)</button>
                                <a href="/events/<%= eventId %>/smsTemplate" class="btn btn-secondary">返回 (Back)</a>
                            </form>
                            <div id="alertContainer" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include ("./components/footer") %>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#smsTemplateForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                type: $('#type').val(),
                content: $('#content').val()
            };
            
            $.ajax({
                url: '/events/<%= eventId %>/smsTemplate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            SMS 模板創建成功！(SMS template created successfully!)
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    `;
                    $('#alertContainer').html(alertHtml);
                    setTimeout(() => {
                        window.location.href = '/events/<%= eventId %>/smsTemplate';
                    }, 1500);
                },
                error: function(error) {
                    console.error('Error creating SMS template:', error);
                    const errorMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : '創建失敗 (Failed to create SMS template)';
                    const alertHtml = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${errorMsg}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    `;
                    $('#alertContainer').html(alertHtml);
                }
            });
        });
    });
</script>

