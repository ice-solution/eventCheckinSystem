<%- include ("components/header") %>
<%- include ("components/menu", {eventId: eventId }) %>
<link rel="stylesheet" href="/admin/assets/css/cs-skin-elastic.css">
<link rel="stylesheet" href="/admin/assets/css/lib/datatable/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="/admin/assets/css/style.css">
<div id="right-panel" class="right-panel">
    <%- include ("components/rightpanel_header") %>
    <div class="content">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <strong class="card-title">獎品管理 - <%= event.name %></strong>
                        </div>
                        <div class="card-body">
                            <table id="bootstrap-data-table" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>獎品名稱</th>
                                        <th>圖片</th>
                                        <th>數量</th>
                                        <th>創建時間</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% prizes.forEach(prize => { %>
                                        <tr>
                                            <td><%= prize.name %></td>
                                            <td>
                                                <% if (prize.picture) { %>
                                                    <img src="<%= prize.picture %>" alt="<%= prize.name %>" style="max-width: 50px; max-height: 50px; object-fit: cover; border-radius: 4px;">
                                                <% } else { %>
                                                    <span class="text-muted">無圖片</span>
                                                <% } %>
                                            </td>
                                            <td><%= prize.unit %></td>
                                            <td class="prize-date"><%= prize.created_at %></td>
                                            <td>
                                                <a href="/prizes/<%= eventId %>/prizes/<%= prize._id %>/edit" class="btn btn-sm btn-primary">編輯</a>
                                                <button class="btn btn-sm btn-danger" onclick="deletePrize('<%= prize._id %>')">刪除</button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                            <div class="mb-3">
                                <a href="/prizes/<%= eventId %>/prizes/create" class="btn btn-primary">新增獎品</a>
                                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#batchUploadModal">批量上傳</button>
                                <a href="/prizes/<%= eventId %>/prizes/download-sample" class="btn btn-info">下載範本</a>
                                <button type="button" class="btn btn-danger" onclick="deleteAllPrizes()">一鍵刪除全部獎品</button>
                                <a href="/events/<%= eventId %>" class="btn btn-secondary">返回事件</a>
                            </div>
                            
                            <!-- 批量上傳 Modal -->
                            <div class="modal fade" id="batchUploadModal" tabindex="-1" role="dialog" aria-labelledby="batchUploadModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="batchUploadModalLabel">xlsx上傳獎品</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="batchUploadForm" enctype="multipart/form-data">
                                                <div class="form-group">
                                                    <label for="excelFile">選擇 Excel 檔案 (.xlsx)</label>
                                                    <input type="file" class="form-control-file" id="excelFile" name="file" accept=".xlsx,.xls" required>
                                                    <small class="form-text text-muted">
                                                        請上傳包含以下欄位的 Excel 檔案：<br>
                                                        - name (獎品名稱，必填)<br>
                                                        - unit (數量，必填，數字)<br>
                                                        - picture (圖片 URL，選填)
                                                    </small>
                                                </div>
                                                <div id="uploadProgress" class="progress" style="display: none;">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                                </div>
                                                <div id="uploadMessage" class="alert" style="display: none;"></div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                                            <button type="button" class="btn btn-primary" onclick="submitBatchUpload()">上傳</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include ("./components/footer") %>
<script src="/admin/assets/js/lib/data-table/datatables.min.js"></script>
<script src="/admin/assets/js/lib/data-table/dataTables.bootstrap.min.js"></script>
<script src="/admin/assets/js/lib/data-table/dataTables.buttons.min.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.bootstrap.min.js"></script>
<script src="/admin/assets/js/lib/data-table/jszip.min.js"></script>
<script src="/admin/assets/js/lib/data-table/vfs_fonts.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.html5.min.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.print.min.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.colVis.min.js"></script>
<script src="/admin/assets/js/init/datatables-init.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#bootstrap-data-table').DataTable();
        
        // 格式化日期為 GMT+8 (Asia/Taipei)
        $('.prize-date').each(function() {
            const dateStr = $(this).text().trim();
            if (dateStr) {
                try {
                    const date = new Date(dateStr);
                    const formattedDate = date.toLocaleString('zh-TW', { 
                        timeZone: 'Asia/Taipei', 
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    $(this).text(formattedDate);
                } catch (e) {
                    console.error('Error formatting date:', e);
                }
            }
        });
    });

    function deletePrize(prizeId) {
        if (confirm('確定要刪除這個獎品嗎？')) {
            fetch(`/prizes/<%= eventId %>/prizes/${prizeId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('刪除失敗');
            });
        }
    }

    function submitBatchUpload() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('請選擇檔案');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        const progressDiv = document.getElementById('uploadProgress');
        const messageDiv = document.getElementById('uploadMessage');
        
        progressDiv.style.display = 'block';
        messageDiv.style.display = 'none';

        fetch(`/prizes/<%= eventId %>/prizes/batch-upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            progressDiv.style.display = 'none';
            messageDiv.style.display = 'block';
            
            if (data.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = `成功上傳 ${data.importedCount} 個獎品！`;
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = data.message || '上傳失敗';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            progressDiv.style.display = 'none';
            messageDiv.style.display = 'block';
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = '上傳失敗：' + error.message;
        });
    }

    function deleteAllPrizes() {
        const totalPrizes = <%= prizes.length %>;
        
        if (totalPrizes === 0) {
            alert('目前沒有任何獎品可以刪除');
            return;
        }

        // 第一次確認
        if (!confirm(`警告：您即將刪除所有 ${totalPrizes} 個獎品！\n\n這是一個不可逆的操作，請確認您真的要執行此操作。`)) {
            return;
        }

        // 第二次確認
        if (!confirm(`再次確認：您確定要刪除所有 ${totalPrizes} 個獎品嗎？\n\n此操作無法復原！`)) {
            return;
        }

        // 第三次確認
        if (!confirm(`最後確認：您真的要刪除所有 ${totalPrizes} 個獎品嗎？\n\n請輸入 "確認刪除" 來完成此操作。\n\n（請在提示框中輸入：確認刪除）`)) {
            return;
        }

        // 第四次確認 - 要求輸入特定文字
        const userInput = prompt(`請輸入 "確認刪除" 來確認刪除所有 ${totalPrizes} 個獎品：`);
        if (userInput !== '確認刪除') {
            alert('操作已取消');
            return;
        }

        // 執行刪除
        fetch(`/prizes/<%= eventId %>/prizes`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`成功刪除 ${data.deletedCount} 個獎品！`);
                location.reload();
            } else {
                alert('刪除失敗：' + (data.message || '未知錯誤'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('刪除失敗：' + error.message);
        });
    }
</script> 