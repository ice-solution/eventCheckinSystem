<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>LuckyDraw æ§åˆ¶é¢æ¿</title>
    <link rel="stylesheet" href="/admin/assets/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="/admin/assets/css/lib/datatable/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="/admin/assets/css/style.css">

    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .control-panel-container {
            padding: 20px;
        }
        .control-card {
            border-radius: 8px;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .form-group label {
            font-weight: 600;
        }
        .winner-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .winner-main {
            display: flex;
            flex-direction: column;
        }
        .winner-name {
            font-weight: 600;
        }
        .winner-meta {
            font-size: 12px;
            color: #666;
        }
        .connection-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 13px;
            color: #fff;
            background-color: rgba(220, 53, 69, 0.9); /* default danger */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        .connection-toast.show {
            opacity: 1;
        }
        .connection-toast.success {
            background-color: rgba(40, 167, 69, 0.9);
        }
        .connection-toast.warning {
            background-color: rgba(255, 193, 7, 0.9);
        }
        @media (max-width: 992px) {
            .control-panel-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
<%- include("components/header") %>
<%- include("components/menu", { eventId: eventId }) %>

<div id="right-panel" class="right-panel">
    <%- include("components/rightpanel_header") %>

    <div class="content">
        <div class="animated fadeIn">
            <div class="row control-panel-container">
                <div class="col-lg-7 col-md-12 mb-3">
                    <div class="card control-card">
                        <div class="section-title">æŠ½çæ§åˆ¶ï¼ˆé©åˆ iPad æ“ä½œï¼‰</div>
                        <div class="form-group">
                            <label for="prizeSelect">é¸æ“‡çå“ï¼š</label>
                            <div class="mb-2" id="prizeImageContainer" style="display:none; text-align:center;">
                                <img id="prizeImage" src="" alt="é¸æ“‡çå“" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #eee;">
                            </div>
                            <select id="prizeSelect" class="form-control" required>
                                <option value="">è«‹é¸æ“‡çå“</option>
                                <% prizes.forEach(prize => { %>
                                    <% if (prize.unit > 0) { %>
                                        <option value="<%= prize._id %>" data-name="<%= prize.name %>" data-image="<%= prize.pictureUrl || prize.picture || '' %>">
                                            <%= prize.name %> (å‰©é¤˜: <%= prize.unit %>)
                                        </option>
                                    <% } %>
                                <% }); %>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label for="drawCount">æŠ½çæ¬¡æ•¸ï¼š</label>
                                <input type="number" id="drawCount" class="form-control" min="1" value="1">
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <button id="btn-draw-once" class="btn btn-primary btn-block mb-2">æŠ½ 1 äºº</button>
                            <button id="btn-draw-multi" class="btn btn-success btn-block mb-2">æŒ‰ä¸Šæ–¹æ¬¡æ•¸é€£æŠ½</button>
                            <button id="btn-cancel-last" class="btn btn-warning btn-block mb-2">å–æ¶ˆä¸Šä¸€ä½ä¸­çè€…</button>
                        </div>

                        <hr>

                        <div class="section-title">è‡ªè¨‚ä¸­çäººç‰©</div>
                        <div class="form-group">
                            <label for="manualWinnerSelect">é¸æ“‡åƒèˆ‡è€…ï¼š</label>
                            <select id="manualWinnerSelect" class="form-control">
                                <option value="">è«‹é¸æ“‡åƒèˆ‡è€…</option>
                                <% availablePeople.forEach(person => { %>
                                    <option value="<%= person._id %>">
                                        <%= person.company || '' %>
                                        <% if (person.table) { %> | æ¡Œè™Ÿ: <%= person.table %> <% } %>
                                        | <%= person.name %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <button id="btn-set-manual-winner" class="btn btn-info btn-block">è¨­ç‚ºä¸­çè€…</button>
                    </div>
                </div>

                <div class="col-lg-5 col-md-12 mb-3">
                    <div class="card control-card">
                        <div class="section-title">æœ¬æ¬¡æ“ä½œä¸­çç´€éŒ„</div>
                        <ul id="winnerList" class="winner-list"></ul>
                        <small class="text-muted d-block mt-2">
                            èªªæ˜ï¼šæ­¤åˆ—è¡¨åªé¡¯ç¤ºæœ¬æ¬¡é¢æ¿æ“ä½œçš„ä¸­çè€…ã€‚å®Œæ•´ç´€éŒ„è«‹æŸ¥çœ‹ã€ŒLuckydraw Listã€é é¢ã€‚
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="controllerToast" class="connection-toast"></div>
<%- include("components/footer") %>

<script src="/socket.io/socket.io.js"></script>
<script>
    const allPeople = <%- JSON.stringify(availablePeople) %>;
    const allPrizes = <%- JSON.stringify(prizes) %>; // ä¿å­˜æ‰€æœ‰çå“æ•¸æ“š
    const eventId = '<%= eventId %>';

    let availablePeople = [...allPeople];
    const sessionWinners = [];

    const prizeSelect = document.getElementById('prizeSelect');
    const prizeImage = document.getElementById('prizeImage');
    const prizeImageContainer = document.getElementById('prizeImageContainer');
    const drawCountInput = document.getElementById('drawCount');
    const winnerList = document.getElementById('winnerList');
    const manualWinnerSelect = document.getElementById('manualWinnerSelect');

    // åˆå§‹åŒ– Socket.IO ä¸¦åŠ å…¥ luckydraw room
    const socket = io();
    socket.emit('join_luckydraw', { eventId, type: 'panel' });

    const controllerToast = document.getElementById('controllerToast');
    let toastTimer = null;

    function showControllerToast(message, type) {
        controllerToast.textContent = message;
        controllerToast.classList.remove('success', 'warning');
        if (type === 'success') controllerToast.classList.add('success');
        if (type === 'warning') controllerToast.classList.add('warning');
        controllerToast.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            controllerToast.classList.remove('show');
        }, 2000);
    }

    function updatePrizePreview() {
        const selectedOption = prizeSelect.options[prizeSelect.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            prizeImageContainer.style.display = 'none';
            return;
        }
        const imagePath = selectedOption.dataset.image;
        if (imagePath && imagePath.trim() !== '') {
            prizeImage.src = imagePath;
            prizeImageContainer.style.display = 'block';
        } else {
            prizeImageContainer.style.display = 'none';
        }
    }

    function sendPrizeSelection() {
        const selectedOption = prizeSelect.options[prizeSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            const prizeName = selectedOption.dataset.name || selectedOption.text.split('(')[0].trim();
            const prizeImage = selectedOption.dataset.image || '';
            socket.emit('luckydraw_panel_prize_selected', { 
                eventId, 
                prizeName: prizeName,
                prizeImage: prizeImage
            });
        } else {
            // æ¸…é™¤çå“é¸æ“‡
            socket.emit('luckydraw_panel_prize_selected', { 
                eventId, 
                prizeName: null,
                prizeImage: null
            });
        }
    }

    prizeSelect.addEventListener('change', () => {
        updatePrizePreview();
        sendPrizeSelection();
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        updatePrizePreview();
        // é é¢è¼‰å…¥å¾Œï¼Œå¦‚æœæœ‰å·²é¸æ“‡çš„çå“ï¼Œç™¼é€é¸æ“‡äº‹ä»¶
        setTimeout(sendPrizeSelection, 500);
    });

    async function cancelWinner(winner) {
        if (!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${winner.name} çš„ä¸­ççµæœï¼Ÿ`)) {
            return;
        }
        try {
            const res = await fetch(`/events/${eventId}/luckydraw`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ _id: winner._id })
            });
            if (!res.ok) {
                const msg = await res.text();
                alert('å–æ¶ˆä¸­çè€…å¤±æ•—ï¼š' + msg);
                return;
            }
            // å¾ sessionWinners ä¸­ç§»é™¤
            const index = sessionWinners.findIndex(w => String(w._id) === String(winner._id));
            if (index !== -1) {
                sessionWinners.splice(index, 1);
                renderWinnerList();
            }

            // é‚„åŸçå“æ•¸é‡
            if (winner.prizeId) {
                const option = Array.from(prizeSelect.options).find(o => o.value === winner.prizeId);
                if (option) {
                    const text = option.text;
                    const match = text.match(/\(å‰©é¤˜: (\d+)\)/);
                    const currentRemaining = match ? parseInt(match[1]) : 0;
                    updatePrizeOptionText(option, currentRemaining + 1);
                } else {
                    // é¸é …ä¸å­˜åœ¨ï¼ˆå› ç‚ºæ•¸é‡ç‚º0æ™‚è¢«ç§»é™¤äº†ï¼‰ï¼Œéœ€è¦é‡æ–°å‰µå»º
                    const prize = allPrizes.find(p => String(p._id) === String(winner.prizeId));
                    const newOption = document.createElement('option');
                    newOption.value = winner.prizeId;
                    newOption.dataset.name = winner.prizeName || prize?.name || 'æœªçŸ¥çå“';
                    newOption.dataset.image = prize?.pictureUrl || prize?.picture || '';
                    newOption.text = `${winner.prizeName || prize?.name || 'æœªçŸ¥çå“'} (å‰©é¤˜: 1)`;
                    if (prizeSelect.options.length > 1) {
                        prizeSelect.insertBefore(newOption, prizeSelect.options[1]);
                    } else {
                        prizeSelect.appendChild(newOption);
                    }
                }
            }

            // é‚„åŸåƒèˆ‡è€…åˆ°å¯ç”¨åˆ—è¡¨
            availablePeople.push({
                _id: winner._id,
                name: winner.name,
                company: winner.company,
                table: winner.table
            });
            
            // æ›´æ–°æ‰‹å‹•é¸æ“‡ä¸‹æ‹‰åˆ—è¡¨
            const manualOption = document.createElement('option');
            manualOption.value = winner._id;
            manualOption.text = `${winner.company || ''} ${winner.table ? ' | æ¡Œè™Ÿ: ' + winner.table : ''} | ${winner.name}`;
            manualWinnerSelect.appendChild(manualOption);
        } catch (err) {
            console.error(err);
            alert('å–æ¶ˆä¸­çè€…æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    }

    function renderWinnerList() {
        winnerList.innerHTML = '';
        sessionWinners.forEach((w) => {
            const li = document.createElement('li');
            li.className = 'winner-item';
            li.dataset.id = w._id;
            li.style.cursor = 'pointer';
            li.style.userSelect = 'none';
            li.title = 'é»æ“Šå–æ¶ˆæ­¤ä¸­çè€…';
            // ä½¿ç”¨ä¸­çç·¨è™Ÿï¼ˆorderï¼‰å–ä»£åºè™Ÿ
            const orderNumber = w.order || '';
            li.innerHTML = `
                <div class="winner-main">
                    <span class="winner-name">${orderNumber ? orderNumber + '. ' : ''}${w.name}</span>
                    <span class="winner-meta">
                        ${w.company || ''} ${w.table ? ' | æ¡Œè™Ÿ: ' + w.table : ''} ${w.prizeName ? ' | ğŸ ' + w.prizeName : ''}
                    </span>
                </div>
            `;
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            li.addEventListener('click', () => {
                cancelWinner(w);
            });
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            li.addEventListener('mouseenter', () => {
                li.style.backgroundColor = '#f8f9fa';
            });
            li.addEventListener('mouseleave', () => {
                li.style.backgroundColor = '';
            });
            winnerList.appendChild(li);
        });
    }

    // é€£ç·šç‹€æ…‹æç¤ºï¼ˆæ§åˆ¶å™¨æœ¬èº«ï¼‰
    socket.on('connect', () => {
        showControllerToast('æ§åˆ¶å™¨å·²é€£æ¥ä¼ºæœå™¨', 'success');
    });

    socket.on('disconnect', () => {
        showControllerToast('æ§åˆ¶å™¨é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡', 'warning');
    });

    // ä¾†è‡ªä¼ºæœå™¨çš„æ§åˆ¶å™¨ç‹€æ…‹å»£æ’­ï¼ˆåŒä¸€ event çš„æ‰€æœ‰é é¢éƒ½æœƒæ”¶åˆ°ï¼‰
    socket.on('luckydraw:controller_status', ({ status }) => {
        if (status === 'online') {
            showControllerToast('æ§åˆ¶å™¨å·²å°±ç·’ï¼Œå¯ä»¥é–‹å§‹æŠ½ç', 'success');
        } else if (status === 'offline') {
            showControllerToast('æ§åˆ¶å™¨ç›®å‰æœªé€£æ¥', 'warning');
        }
    });

    function pickRandomPerson() {
        if (availablePeople.length === 0) {
            alert('æ‰€æœ‰äººéƒ½å·²æŠ½å‡ºï¼');
            return null;
        }
        const idx = Math.floor(Math.random() * availablePeople.length);
        return availablePeople.splice(idx, 1)[0];
    }

    function getSelectedPrize() {
        if (!prizeSelect.value) {
            alert('è«‹å…ˆé¸æ“‡çå“ï¼');
            return null;
        }
        const option = prizeSelect.options[prizeSelect.selectedIndex];
        const text = option.text;
        const match = text.match(/\(å‰©é¤˜: (\d+)\)/);
        if (!match) {
            alert('ç„¡æ³•ç²å–çå“åº«å­˜ä¿¡æ¯ï¼');
            return null;
        }
        const remaining = parseInt(match[1]);
        if (remaining <= 0) {
            alert('æ‰€é¸çå“å·²ç„¡åº«å­˜ï¼');
            return null;
        }
        return {
            prizeId: option.value,
            prizeName: option.dataset.name || '',
            remaining,
            option
        };
    }

    function updatePrizeOptionText(option, newRemaining) {
        if (newRemaining <= 0) {
            option.remove();
            if (prizeSelect.options.length > 0) {
                prizeSelect.selectedIndex = 0;
            }
        } else {
            option.text = option.text.replace(/\(å‰©é¤˜: \d+\)/, `(å‰©é¤˜: ${newRemaining})`);
        }
    }

    async function confirmWinner(person) {
        const prizeInfo = getSelectedPrize();
        if (!prizeInfo) return;

        const payload = {
            _id: person._id,
            name: person.name,
            company: person.company,
            table: person.table,
            prizeId: prizeInfo.prizeId
        };

        try {
            const res = await fetch(`/events/${eventId}/luckydraw`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const msg = await res.text();
                alert('æ–°å¢ä¸­çè€…å¤±æ•—ï¼š' + msg);
                return;
            }
            const data = await res.json();
            const winner = {
                ...data.winner,
                prizeName: prizeInfo.prizeName
            };
            sessionWinners.push(winner);
            renderWinnerList();

            const newRemaining = prizeInfo.remaining - 1;
            updatePrizeOptionText(prizeInfo.option, newRemaining);
        } catch (err) {
            console.error(err);
            alert('æ–°å¢ä¸­çè€…æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    }

    document.getElementById('btn-draw-once').addEventListener('click', async () => {
        // é€šçŸ¥å±•ç¤ºé é–‹å§‹å‹•ç•«
        socket.emit('luckydraw_panel_start', { eventId });
        const person = pickRandomPerson();
        if (!person) return;
        await confirmWinner(person);
    });

    document.getElementById('btn-draw-multi').addEventListener('click', async () => {
        const prizeInfo = getSelectedPrize();
        if (!prizeInfo) return;
        
        const count = Math.max(1, parseInt(drawCountInput.value || '1', 10));
        
        if (prizeInfo.remaining <= 0) {
            alert('çå“å·²ç„¡åº«å­˜ï¼Œç„¡æ³•æŠ½çã€‚');
            return;
        }

        if (count > prizeInfo.remaining) {
            alert(`çå“åº«å­˜ä¸è¶³ï¼Œæœ€å¤šåªèƒ½æŠ½å– ${prizeInfo.remaining} å€‹ã€‚`);
            return;
        }

        if (availablePeople.length < count) {
            alert(`å¯ç”¨äººæ•¸ä¸è¶³ï¼Œç›®å‰åªæœ‰ ${availablePeople.length} äººå¯æŠ½ã€‚`);
            return;
        }

        // é€šçŸ¥å±•ç¤ºé é–‹å§‹å‹•ç•«ï¼ˆåªé€šçŸ¥ä¸€æ¬¡ï¼‰
        socket.emit('luckydraw_panel_start', { eventId });

        try {
            // ä½¿ç”¨æ‰¹é‡æŠ½ç API
            const res = await fetch(`/events/${eventId}/luckydraw/batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    count: count,
                    prizeId: prizeInfo.prizeId
                })
            });

            if (!res.ok) {
                const msg = await res.text();
                alert('æ‰¹é‡æŠ½çå¤±æ•—ï¼š' + msg);
                return;
            }

            const data = await res.json();
            
            // æ›´æ–°å¯ç”¨äººå“¡åˆ—è¡¨ï¼ˆç§»é™¤å·²ä¸­ççš„äººï¼‰
            if (data.winners && Array.isArray(data.winners)) {
                data.winners.forEach(winner => {
                    const index = availablePeople.findIndex(p => String(p._id) === String(winner._id));
                    if (index !== -1) {
                        availablePeople.splice(index, 1);
                    }
                    sessionWinners.push({
                        ...winner,
                        prizeName: prizeInfo.prizeName
                    });
                });
            }

            renderWinnerList();

            // æ›´æ–°çå“é¸é …æ–‡å­—
            const newRemaining = prizeInfo.remaining - data.actualCount;
            updatePrizeOptionText(prizeInfo.option, newRemaining);

            // Socket äº‹ä»¶å·²ç¶“ç”±å¾Œç«¯ API ç™¼é€ï¼Œé€™è£¡ä¸éœ€è¦å†ç™¼é€
            // å¾Œç«¯æœƒè‡ªå‹•ç™¼é€ luckydraw:winner_added äº‹ä»¶çµ¦æ‰€æœ‰é€£æ¥çš„å®¢æˆ¶ç«¯
        } catch (err) {
            console.error(err);
            alert('æ‰¹é‡æŠ½çæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
        }
    });

    document.getElementById('btn-cancel-last').addEventListener('click', async () => {
        if (sessionWinners.length === 0) {
            alert('ç›®å‰æ²’æœ‰å¯å–æ¶ˆçš„ä¸­çè€…ã€‚');
            return;
        }
        const lastWinner = sessionWinners[sessionWinners.length - 1];
        if (!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${lastWinner.name} çš„ä¸­ççµæœï¼Ÿ`)) {
            return;
        }
        try {
            const res = await fetch(`/events/${eventId}/luckydraw`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ _id: lastWinner._id })
            });
            if (!res.ok) {
                const msg = await res.text();
                alert('å–æ¶ˆä¸­çè€…å¤±æ•—ï¼š' + msg);
                return;
            }
            sessionWinners.pop();
            renderWinnerList();

            // é‚„åŸçå“æ•¸é‡
            if (lastWinner.prizeId) {
                const option = Array.from(prizeSelect.options).find(o => o.value === lastWinner.prizeId);
                if (option) {
                    const text = option.text;
                    const match = text.match(/\(å‰©é¤˜: (\d+)\)/);
                    const currentRemaining = match ? parseInt(match[1]) : 0;
                    updatePrizeOptionText(option, currentRemaining + 1);
                } else {
                    // é¸é …ä¸å­˜åœ¨ï¼ˆå› ç‚ºæ•¸é‡ç‚º0æ™‚è¢«ç§»é™¤äº†ï¼‰ï¼Œéœ€è¦é‡æ–°å‰µå»º
                    const prize = allPrizes.find(p => String(p._id) === String(lastWinner.prizeId));
                    const newOption = document.createElement('option');
                    newOption.value = lastWinner.prizeId;
                    newOption.dataset.name = lastWinner.prizeName || prize?.name || 'æœªçŸ¥çå“';
                    newOption.dataset.image = prize?.pictureUrl || prize?.picture || '';
                    newOption.text = `${lastWinner.prizeName || prize?.name || 'æœªçŸ¥çå“'} (å‰©é¤˜: 1)`;
                    if (prizeSelect.options.length > 1) {
                        prizeSelect.insertBefore(newOption, prizeSelect.options[1]);
                    } else {
                        prizeSelect.appendChild(newOption);
                    }
                }
            }

            availablePeople.push({
                _id: lastWinner._id,
                name: lastWinner.name,
                company: lastWinner.company,
                table: lastWinner.table
            });
        } catch (err) {
            console.error(err);
            alert('å–æ¶ˆä¸­çè€…æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    });

    document.getElementById('btn-set-manual-winner').addEventListener('click', async () => {
        const selectedId = manualWinnerSelect.value;
        if (!selectedId) {
            alert('è«‹å…ˆé¸æ“‡ä¸€ä½åƒèˆ‡è€…');
            return;
        }
        const index = availablePeople.findIndex(p => String(p._id) === String(selectedId));
        if (index === -1) {
            alert('æ‰¾ä¸åˆ°é¸æ“‡çš„åƒèˆ‡è€…ï¼Œå¯èƒ½å·²ä¸­çæˆ–ä¸åœ¨åå–®ä¸­ã€‚');
            return;
        }
        // é€šçŸ¥å±•ç¤ºé é–‹å§‹å‹•ç•«
        socket.emit('luckydraw_panel_start', { eventId });
        const person = availablePeople.splice(index, 1)[0];
        await confirmWinner(person);
        manualWinnerSelect.value = '';
    });
</script>

</body>
</html>


