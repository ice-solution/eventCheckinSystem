<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>User List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .checkin-true {
            background-color: #E9F0FE !important; /* Green background */
        }
        .checkin-false {
            background-color: #FFF !important; /* Yellow background */
        }
        .add-user-form {
            display: none; /* Initially hidden */
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<%- include ("components/header") %>
<%- include ("components/menu", { eventId: event._id }) %>
<link rel="stylesheet" href="/admin/assets/css/cs-skin-elastic.css">
<!-- <link rel="stylesheet" href="/admin/assets/css/lib/datatable/dataTables.bootstrap.min.css"> -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/editor/2.0.2/css/editor.dataTables.min.css">
<link rel="stylesheet" href="/admin/assets/css/style.css">

<div id="right-panel" class="right-panel">
    <%- include ("components/rightpanel_header") %>
    <div class="content">
        <div class="animated fadeIn">
            <div id="alertContainer"></div>
            <div class="row">
                <div class="col-lg-4 col-md-6">
                    <div class="card">
                        <% 
                            const totalUsers = event.users.length; 
                            const checkedInUsers = event.users.filter(user => user.isCheckIn).length; 
                            const checkInRate = totalUsers > 0 ? ((checkedInUsers / totalUsers) * 100).toFixed(2) : 0; 
                        %>
                        <div class="card-body">
                            <div class="stat-widget-five">
                                <div class="stat-icon dib flat-color-1">
                                    <i class="pe-7s-user"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="text-left dib">
                                        <div class="stat-text"><span class="count"><%= checkedInUsers %></span></div>
                                        <div class="stat-heading">Checked In Users</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="stat-widget-five">
                                <div class="stat-icon dib flat-color-2">
                                    <i class="pe-7s-users"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="text-left dib">
                                        <div class="stat-text"><span class="count"><%= totalUsers %></span></div>
                                        <div class="stat-heading">Total Users</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="stat-widget-five">
                                <div class="stat-icon dib flat-color-3">
                                    <i class="pe-7s-calculator"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="text-left dib">
                                        <div class="stat-text"><span class="count"><%= checkInRate %></span>%</div>
                                        <div class="stat-heading">Check-in Rate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12 col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <strong class="card-title"><%= event.name %> User List</strong>
                        </div>
                        <div class="card-body">
                            <div>
                                <a href="/events/<%= event._id %>" class="btn btn-outline-secondary">User List</a>
                                <a href="/events/<%= event._id%>/scan" class="btn btn-outline-secondary">Scan QR Code</a>
                                <a href="/events/<%= event._id%>/import" class="btn btn-outline-secondary">Import Data</a>

                                <a href="/events/<%= event._id %>/report" class="btn btn-outline-success ml-2">Download Report</a>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="paymentEvent">
                                    <label class="form-check-label" for="paymentEvent">Payment Event</label>
                                </div>
                            </div>
                            <div class="clearfix" style="margin-top:20px"></div>


                            <table id="usersTable" class="display">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Name</th>
                                        <th>Table</th>
                                        <th>Company</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Salutation</th>
                                        <th>Industry</th>
                                        <th>Transport</th>
                                        <th>Meal Choice</th>
                                        <th>Remarks</th>
                                        <th>Checked In</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% event.users.forEach(user => { %>
                                        <tr class="<%= user.isCheckIn ? 'checkin-true' : 'checkin-false' %>" data-id="<%= user._id %>">
                                            <td><%= user.email %></td>
                                            <td><%= user.name %></td>
                                            <td><%= user.table %></td>
                                            <td><%= user.company %></td>
                                            <td><%= user.phone %></td>
                                            <td><%= user.role %></td>
                                            <td><%= user.saluation %></td>
                                            <td><%= user.industry %></td>
                                            <td><%= user.transport %></td>
                                            <td><%= user.meal %></td>
                                            <td><%= user.remarks %></td>
                                            <td>
                                                <input type="checkbox" class="checkin-toggle" data-_id="<%= user._id %>" <%= user.isCheckIn ? 'checked' : '' %> />
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include ("components/footer") %>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/editor/2.0.2/js/dataTables.editor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize DataTable with Editor
        const editor = new $.fn.dataTable.Editor({
            ajax: {
                create: {
                    url: `/events/<%= event._id %>/users`,
                    type: 'POST'
                },
                edit: {
                    url: `/events/<%= event._id %>/users/_id_`,
                    type: 'PUT'
                },
                remove: {
                    url: `/events/<%= event._id %>/users/_id_`,
                    type: 'DELETE'
                }
            },
            table: '#usersTable',
            fields: [
                { label: 'Email', name: 'email', type: 'text' },
                { label: 'Name', name: 'name', type: 'text' },
                { label: 'Table', name: 'table', type: 'text' },
                { label: 'Company', name: 'company', type: 'text' },
                { label: 'Phone', name: 'phone', type: 'text' },
                { 
                    label: 'Role', 
                    name: 'role', 
                    type: 'select',
                    options: [
                        { label: 'Guests', value: 'guests' },
                        { label: 'VIP', value: 'vip' }
                    ]
                },
                { 
                    label: 'Salutation', 
                    name: 'saluation', 
                    type: 'select',
                    options: [
                        { label: 'Mr', value: 'Mr' },
                        { label: 'Mrs', value: 'Mrs' },
                        { label: 'Miss', value: 'Miss' }
                    ]
                },
                { label: 'Industry', name: 'industry', type: 'text' },
                { label: 'Transport', name: 'transport', type: 'text' },
                { 
                    label: 'Meal Choice', 
                    name: 'meal', 
                    type: 'select',
                    options: [
                        { label: 'A', value: 'A' },
                        { label: 'B', value: 'B' },
                        { label: 'C', value: 'C' }
                    ]
                },
                { label: 'Remarks', name: 'remarks', type: 'textarea' }
            ]
        });

        const table = $('#usersTable').DataTable({
            pageLength: 50,
            dom: 'Bfrtip',
            buttons: [
                { extend: 'create', editor: editor },
                { extend: 'edit', editor: editor },
                { extend: 'remove', editor: editor },
                'copy', 'csv', 'excel', 'pdf', 'print'
            ],
            columnDefs: [
                {
                    targets: -1, // Last column (Checked In)
                    orderable: false,
                    searchable: false,
                    data: null,
                    defaultContent: '<input type="checkbox" class="checkin-toggle" />'
                }
            ]
        });

        // Use event delegation to listen for checkbox changes
        $('#usersTable tbody').on('change', '.checkin-toggle', function() {
            const row = $(this).closest('tr');
            const _id = row.data('id');
            const isCheckIn = $(this).is(':checked');
            const event_id = '<%= event._id %>';

            // Send AJAX request to update isCheckIn
            $.ajax({
                url: `/events/${event_id}/users/${_id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ isCheckIn: isCheckIn }),
                success: function(response) {
                    // Update row color
                    if (isCheckIn) {
                        row.removeClass('checkin-false').addClass('checkin-true');
                    } else {
                        row.removeClass('checkin-true').addClass('checkin-false');
                    }

                    // Show success alert
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            Update successful!
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    `;
                    $('#alertContainer').append(alertHtml);
                    // Auto-hide alert
                    setTimeout(() => {
                        $('.alert').alert('close');
                    }, 1500);
                },
                error: function(xhr, status, error) {
                    console.error('Error updating user:', error);
                    alert('Update failed, please try again later.');
                }
            });
        });



        // 取得 eventId
        const eventId = '<%= event._id %>';
        // 初始化票券資料
        let paymentTickets = <%- JSON.stringify(event.PaymentTickets || []) %>;
        let isPaymentEvent = <%- event.isPaymentEvent ? 'true' : 'false' %>;

        // Payment Event checkbox 狀態初始化
        $('#paymentEvent').prop('checked', isPaymentEvent);
        if(isPaymentEvent) showTicketFields();

        // 動態顯示票券欄位
        function showTicketFields() {
            if($('#ticketFields').length) return;
            const html = `
                <form id="paymentEventForm" class="mt-3">
                    <h5>票券設定</h5>
                    <div id="ticketsList"></div>
                    <button type="button" class="btn btn-primary btn-sm" id="addTicketBtn">新增票券</button>
                    <button type="submit" class="btn btn-success btn-sm ml-2">儲存付費設定</button>
                </form>
            `;
            $('#paymentEvent').closest('.form-check').after(html);
            renderTickets();
        }

        // 渲染票券列表
        function renderTickets() {
            let html = '';
            paymentTickets.forEach((ticket, idx) => {
                html += `
                    <div class="ticket-item mb-2" data-idx="${idx}">
                        <input type="text" class="form-control d-inline-block w-auto mr-2 ticket-title" placeholder="票券名稱" value="${ticket.title || ''}" style="width:120px;">
                        <input type="number" class="form-control d-inline-block w-auto mr-2 ticket-price" placeholder="價格" value="${ticket.price || ''}" style="width:100px;">
                        <input type="datetime-local" class="form-control d-inline-block w-auto mr-2 ticket-datetime" value="${ticket.datetime ? new Date(ticket.datetime).toISOString().slice(0,16) : ''}" style="width:180px;">
                        <button type="button" class="btn btn-danger btn-sm remove-ticket">刪除</button>
                    </div>
                `;
            });
            $('#ticketsList').html(html);
        }

        // 新增票券
        $(document).on('click', '#addTicketBtn', function(e) {
            e.preventDefault();
            paymentTickets.push({ title: '', price: '', datetime: '' });
            renderTickets();
        });

        // 刪除票券
        $(document).on('click', '.remove-ticket', function() {
            const idx = $(this).closest('.ticket-item').data('idx');
            paymentTickets.splice(idx, 1);
            renderTickets();
        });

        // 編輯票券
        $(document).on('change', '.ticket-title, .ticket-price, .ticket-datetime', function() {
            const idx = $(this).closest('.ticket-item').data('idx');
            const row = $(this).closest('.ticket-item');
            paymentTickets[idx].title = row.find('.ticket-title').val();
            paymentTickets[idx].price = Number(row.find('.ticket-price').val());
            paymentTickets[idx].datetime = row.find('.ticket-datetime').val();
        });

        // 提交 payment event form
        $(document).on('submit', '#paymentEventForm', function(e) {
            e.preventDefault();
            const checked = $('#paymentEvent').is(':checked');
            $.ajax({
                url: `/events/${eventId}/paymentEvent`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({ isPaymentEvent: checked, PaymentTickets: paymentTickets }),
                success: function(res) {
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            付費活動設定已更新！
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    `;
                    $('#alertContainer').append(alertHtml);
                    setTimeout(() => { $('.alert').alert('close'); }, 1500);
                }
            });
        });

        // 監聽 Payment Event checkbox，顯示/隱藏票券欄位
        $('#paymentEvent').on('change', function() {
            const checked = $(this).is(':checked');
            if(checked) {
                showTicketFields();
            } else {
                $('#paymentEventForm').remove();
            }
        });
    });
</script>

</body>
</html>

