<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <title>User List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .checkin-true {
            background-color: #E9F0FE !important; /* Green background */
        }
        .checkin-false {
            background-color: #FFF !important; /* Yellow background */
        }
        .add-user-form {
            display: none; /* Initially hidden */
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .user-action-buttons {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }
    </style>
</head>
<body>

<%- include ("components/header") %>
<%- include ("components/menu", { eventId: event._id }) %>
<link rel="stylesheet" href="/admin/assets/css/cs-skin-elastic.css">
<!-- <link rel="stylesheet" href="/admin/assets/css/lib/datatable/dataTables.bootstrap.min.css"> -->
<link rel="stylesheet" href="/admin/assets/css/lib/datatable/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="/admin/assets/css/style.css">

<div id="right-panel" class="right-panel">
    <%- include ("components/rightpanel_header") %>
    <div class="content">
        <div class="animated fadeIn">
            <div id="alertContainer"></div>
            <div class="row">
                <div class="col-lg-4 col-md-6">
                    <div class="card">
                        <% 
                            const totalUsers = event.users.length; 
                            const checkedInUsers = event.users.filter(user => user.isCheckIn).length; 
                            const checkInRate = totalUsers > 0 ? ((checkedInUsers / totalUsers) * 100).toFixed(2) : 0; 
                        %>
                        <div class="card-body">
                            <div class="stat-widget-five">
                                <div class="stat-icon dib flat-color-1">
                                    <i class="pe-7s-user"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="text-left dib">
                                        <div class="stat-text"><span class="count"><%= checkedInUsers %></span></div>
                                        <div class="stat-heading">Checked In Users</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="stat-widget-five">
                                <div class="stat-icon dib flat-color-2">
                                    <i class="pe-7s-users"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="text-left dib">
                                        <div class="stat-text"><span class="count"><%= totalUsers %></span></div>
                                        <div class="stat-heading">Total Users</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="stat-widget-five">
                                <div class="stat-icon dib flat-color-3">
                                    <i class="pe-7s-calculator"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="text-left dib">
                                        <div class="stat-text"><span class="count"><%= checkInRate %></span>%</div>
                                        <div class="stat-heading">Check-in Rate</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12 col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <strong class="card-title"><%= event.name %> User List</strong>
                        </div>
                        <div class="card-body">
                            <div>
                                <a href="/events/<%= event._id %>" class="btn btn-outline-secondary">User List</a>
                                <a href="/events/<%= event._id%>/scan" class="btn btn-outline-secondary">Scan QR Code</a>
                                <a href="/events/<%= event._id%>/import" class="btn btn-outline-secondary">Import Data</a>
                                <a href="/events/<%= event._id%>/banner" class="btn btn-outline-info ml-2">
                                    <i class="fas fa-image"></i> Banner Management
                                </a>

                                <a href="/events/<%= event._id %>/report" class="btn btn-outline-success ml-2">Download Report</a>
                                <a href="/events/<%= event._id %>/transactions" class="btn btn-outline-warning ml-2">
                                    <i class="fa fa-credit-card"></i> Transaction Records
                                </a>
                                <button id="batchDeleteBtn" class="btn btn-danger ml-2" style="display: none;">Batch Delete Selected</button>
                                <button id="batchCheckInBtn" class="btn btn-success ml-2">Batch Check In All</button>
                                <button id="addUserBtn" class="btn btn-primary ml-2">Add User</button>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="paymentEvent">
                                    <label class="form-check-label" for="paymentEvent">Payment Event</label>
                                </div>
                            </div>
                            <div class="clearfix" style="margin-top:20px"></div>

                            <!-- Add User Form -->
                            <div id="addUserForm" class="add-user-form" style="display: none;">
                                <h5>Add New User</h5>
                                <form id="newUserForm">
                                    <% if (formConfig && formConfig.sections) { %>
                                        <% formConfig.sections.forEach((section, sectionIndex) => { %>
                                            <% if (section.visible && section.fields) { %>
                                                <div class="form-section mb-4">
                                                    <h6>
                                                        <% 
                                                        let sectionTitle = '';
                                                        if (typeof section.sectionTitle === 'string') {
                                                            sectionTitle = section.sectionTitle;
                                                        } else if (section.sectionTitle && section.sectionTitle[formConfig.defaultLanguage]) {
                                                            sectionTitle = section.sectionTitle[formConfig.defaultLanguage];
                                                        } else if (section.sectionTitle && section.sectionTitle.zh) {
                                                            sectionTitle = section.sectionTitle.zh;
                                                        } else {
                                                            sectionTitle = section.sectionName || '';
                                                        }
                                                        %>
                                                        <%= sectionTitle %>
                                                    </h6>
                                                    <div class="row">
                                                        <% section.fields.forEach((field, fieldIndex) => { %>
                                                            <% if (field.visible) { %>
                                                                <div class="col-md-6">
                                                                    <div class="form-group">
                                                                        <label for="newUser<%= field.fieldName %>">
                                                                            <% 
                                                                            let fieldLabel = '';
                                                                            if (typeof field.label === 'string') {
                                                                                fieldLabel = field.label;
                                                                            } else if (field.label && field.label[formConfig.defaultLanguage]) {
                                                                                fieldLabel = field.label[formConfig.defaultLanguage];
                                                                            } else if (field.label && field.label.zh) {
                                                                                fieldLabel = field.label.zh;
                                                                            } else {
                                                                                fieldLabel = field.fieldName || '';
                                                                            }
                                                                            %>
                                                                            <%= fieldLabel %>
                                                                            <% if (field.required) { %>
                                                                                <span class="text-danger">*</span>
                                                                            <% } %>
                                                                        </label>
                                                                        <% if (field.type === 'select' && field.options) { %>
                                                                            <select class="form-control" id="newUser<%= field.fieldName %>" name="<%= field.fieldName %>" <%= field.required ? 'required' : '' %>>
                                                                                <option value="">--- 請選擇 ---</option>
                                                                                <% field.options.forEach((option) => { %>
                                                                                    <option value="<%= option.value %>">
                                                                                        <% 
                                                                                        let optionLabel = '';
                                                                                        if (typeof option.label === 'string') {
                                                                                            optionLabel = option.label;
                                                                                        } else if (option.label && option.label[formConfig.defaultLanguage]) {
                                                                                            optionLabel = option.label[formConfig.defaultLanguage];
                                                                                        } else if (option.label && option.label.zh) {
                                                                                            optionLabel = option.label.zh;
                                                                                        } else {
                                                                                            optionLabel = option.value || '';
                                                                                        }
                                                                                        %>
                                                                                        <%= optionLabel %>
                                                                                    </option>
                                                                                <% }); %>
                                                                            </select>
                                                                        <% } else if (field.type === 'textarea') { %>
                                                                            <textarea class="form-control" id="newUser<%= field.fieldName %>" name="<%= field.fieldName %>" 
                                                                                      placeholder="<%= (typeof field.placeholder === 'string' ? field.placeholder : (field.placeholder && field.placeholder[formConfig.defaultLanguage] ? field.placeholder[formConfig.defaultLanguage] : (field.placeholder && field.placeholder.zh ? field.placeholder.zh : ''))) || '' %>" <%= field.required ? 'required' : '' %> rows="3"></textarea>
                                                                        <% } else { %>
                                                                            <input type="<%= field.type %>" class="form-control" id="newUser<%= field.fieldName %>" name="<%= field.fieldName %>" 
                                                                                   placeholder="<%= (typeof field.placeholder === 'string' ? field.placeholder : (field.placeholder && field.placeholder[formConfig.defaultLanguage] ? field.placeholder[formConfig.defaultLanguage] : (field.placeholder && field.placeholder.zh ? field.placeholder.zh : ''))) || '' %>" <%= field.required ? 'required' : '' %>>
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                            <% } %>
                                                        <% }); %>
                                                    </div>
                                                </div>
                                            <% } %>
                                        <% }); %>
                                    <% } else { %>
                                        <!-- 預設表單字段（如果沒有formConfig） -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="newUserEmail">Email *</label>
                                                    <input type="email" class="form-control" id="newUserEmail" name="email" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="newUserName">Name *</label>
                                                    <input type="text" class="form-control" id="newUserName" name="name" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="newUserCompany">Company</label>
                                                    <input type="text" class="form-control" id="newUserCompany" name="company">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="newUserPhone">Phone</label>
                                                    <input type="text" class="form-control" id="newUserPhone" name="phone">
                                                </div>
                                            </div>
                                        </div>
                                    <% } %>
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-success">Add User</button>
                                        <button type="button" class="btn btn-secondary ml-2" id="cancelAddUser">Cancel</button>
                                    </div>
                                </form>
                            </div>

                            <table id="usersTable" class="display">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" /></th>
                                        <% if (formConfig && formConfig.sections) { %>
                                            <% formConfig.sections.forEach(section => { %>
                                                <% if (section.visible && section.fields) { %>
                                                    <% section.fields.forEach(field => { %>
                                                        <% if (field.visible) { %>
                                                            <th>
                                                                <% 
                                                                let displayLabel = '';
                                                                if (typeof field.label === 'string') {
                                                                    displayLabel = field.label;
                                                                } else if (field.label && field.label[formConfig.defaultLanguage]) {
                                                                    displayLabel = field.label[formConfig.defaultLanguage];
                                                                } else if (field.label && field.label.zh) {
                                                                    displayLabel = field.label.zh;
                                                                } else {
                                                                    displayLabel = field.fieldName || '';
                                                                }
                                                                %>
                                                                <%= displayLabel %>
                                                            </th>
                                                        <% } %>
                                                    <% }); %>
                                                <% } %>
                                            <% }); %>
                                        <% } else { %>
                                            <!-- 預設列（如果沒有formConfig） -->
                                            <th>Email</th>
                                            <th>Name</th>
                                            <th>Company</th>
                                            <th>Phone</th>
                                        <% } %>
                                        <th>Checked In</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% event.users.forEach(user => { %>
                                        <tr class="<%= user.isCheckIn ? 'checkin-true' : 'checkin-false' %>" data-id="<%= user._id %>">
                                            <td><input type="checkbox" class="user-select" data-_id="<%= user._id %>" /></td>
                                            <% if (formConfig && formConfig.sections) { %>
                                                <% formConfig.sections.forEach(section => { %>
                                                    <% if (section.visible && section.fields) { %>
                                                        <% section.fields.forEach(field => { %>
                                                            <% if (field.visible) { %>
                                                        <td data-field-name="<%= field.fieldName %>"><%= user[field.fieldName] || '-' %></td>
                                                            <% } %>
                                                        <% }); %>
                                                    <% } %>
                                                <% }); %>
                                            <% } else { %>
                                                <!-- 預設列（如果沒有formConfig） -->
                                            <td data-field-name="email"><%= user.email %></td>
                                            <td data-field-name="name"><%= user.name %></td>
                                            <td data-field-name="company"><%= user.company %></td>
                                            <td data-field-name="phone"><%= user.phone %></td>
                                            <% } %>
                                            <td>
                                                <input type="checkbox" class="checkin-toggle" data-_id="<%= user._id %>" <%= user.isCheckIn ? 'checked' : '' %> />
                                            </td>
                                            <td>
                                                <div class="user-action-buttons">
                                                    <button class="btn btn-outline-primary resend-email" data-_id="<%= user._id %>" title="Resend welcome email">
                                                        <i class="fa fa-envelope mr-1"></i> Resend Welcome Email
                                                    </button>
                                                    <button class="btn btn-danger delete-user" data-_id="<%= user._id %>">Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include ("components/footer") %>
<script src="/admin/assets/js/lib/data-table/datatables.min.js"></script>
<script src="/admin/assets/js/lib/data-table/dataTables.bootstrap.min.js"></script>
<script src="/admin/assets/js/lib/data-table/dataTables.buttons.min.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.bootstrap.min.js"></script>
<script src="/admin/assets/js/lib/data-table/jszip.min.js"></script>
<script src="/admin/assets/js/lib/data-table/vfs_fonts.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.html5.min.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.print.min.js"></script>
<script src="/admin/assets/js/lib/data-table/buttons.colVis.min.js"></script>
<script>
    $(document).ready(function() {
        // Check if DataTables is loaded
        if (typeof $.fn.DataTable === 'undefined') {
            console.error('DataTables is not loaded!');
            alert('DataTables plugin is not loaded. Please refresh the page.');
            return;
        }
        
        // Initialize DataTable with inline editing
        const table = $('#usersTable').DataTable({
            pageLength: 50,
            dom: 'frtip', // Remove buttons
            columnDefs: [
                {
                    targets: 0, // Select checkbox column
                    orderable: false,
                    searchable: false
                },
                {
                    targets: -2, // Checked In column
                    orderable: false,
                    searchable: false
                },
                {
                    targets: -1, // Actions column
                    orderable: false,
                    searchable: false
                }
            ]
        });

        // Resend welcome email functionality
        $('#usersTable tbody').on('click', '.resend-email', function() {
            const _id = $(this).data('_id');
            const event_id = '<%= event._id %>';
            const button = $(this);
            const originalHtml = button.html();

            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

            $.ajax({
                url: `/events/${event_id}/users/${_id}/resend-email`,
                type: 'POST',
                success: function() {
                    showAlert('success', 'Welcome email resent successfully!');
                },
                error: function(xhr) {
                    console.error('Error resending email:', xhr.responseText);
                    showAlert('danger', 'Failed to resend email. Please try again.');
                },
                complete: function() {
                    button.prop('disabled', false).html(originalHtml);
                }
            });
        });

        // Batch delete functionality
        $('#selectAll').on('change', function() {
            const isChecked = $(this).is(':checked');
            $('.user-select').prop('checked', isChecked);
            updateBatchDeleteButton();
        });

        // Individual checkbox change
        $('#usersTable tbody').on('change', '.user-select', function() {
            updateBatchDeleteButton();
            updateSelectAllCheckbox();
        });

        // Update batch delete button visibility
        function updateBatchDeleteButton() {
            const selectedCount = $('.user-select:checked').length;
            if (selectedCount > 0) {
                $('#batchDeleteBtn').show().text(`Batch Delete Selected (${selectedCount})`);
            } else {
                $('#batchDeleteBtn').hide();
            }
        }

        // Update select all checkbox state
        function updateSelectAllCheckbox() {
            const totalCheckboxes = $('.user-select').length;
            const checkedCheckboxes = $('.user-select:checked').length;
            
            if (checkedCheckboxes === 0) {
                $('#selectAll').prop('indeterminate', false).prop('checked', false);
            } else if (checkedCheckboxes === totalCheckboxes) {
                $('#selectAll').prop('indeterminate', false).prop('checked', true);
            } else {
                $('#selectAll').prop('indeterminate', true);
            }
        }

        // Batch delete button click
        $('#batchDeleteBtn').on('click', function() {
            const selectedIds = [];
            $('.user-select:checked').each(function() {
                selectedIds.push($(this).data('_id'));
            });

            if (selectedIds.length === 0) {
                showAlert('warning', 'Please select users to delete.');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedIds.length} selected user(s)?`)) {
                // Send all user IDs in one request
                $.ajax({
                    url: `/events/<%= event._id %>/users/batch`,
                    type: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify({ userIds: selectedIds }),
                    success: function(response) {
                        // Remove all selected rows from DataTable
                        selectedIds.forEach(userId => {
                            const row = $(`.user-select[data-_id="${userId}"]`).closest('tr');
                            table.row(row).remove();
                        });
                        table.draw();
                        
                        showAlert('success', `Successfully deleted ${response.deletedCount} user(s)!`);
                        updateBatchDeleteButton();
                        updateSelectAllCheckbox();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error batch deleting users:', error);
                        showAlert('danger', 'Failed to delete users. Please try again.');
                    }
                });
            }
        });

        // Batch check in button click
        $('#batchCheckInBtn').on('click', function() {
            const totalUsers = <%= event.users.length %>;
            const alreadyCheckedIn = <%= event.users.filter(u => u.isCheckIn).length %>;
            const toCheckIn = totalUsers - alreadyCheckedIn;

            if (toCheckIn === 0) {
                showAlert('info', 'All users are already checked in!');
                return;
            }

            if (confirm(`確定要將所有 ${totalUsers} 位用戶設為已簽到嗎？\n（目前已有 ${alreadyCheckedIn} 位已簽到，將新增 ${toCheckIn} 位）`)) {
                const button = $(this);
                const originalText = button.text();
                button.prop('disabled', true).text('處理中...');

                $.ajax({
                    url: `/events/<%= event._id %>/users/batch-checkin`,
                    type: 'PUT',
                    contentType: 'application/json',
                    success: function(response) {
                        // 更新所有行的 check in 狀態
                        $('#usersTable tbody tr').each(function() {
                            const row = $(this);
                            const checkInCheckbox = row.find('.checkin-toggle');
                            
                            if (!checkInCheckbox.is(':checked')) {
                                checkInCheckbox.prop('checked', true);
                                row.removeClass('checkin-false').addClass('checkin-true');
                            }
                        });
                        
                        showAlert('success', `成功將 ${response.checkedInCount} 位用戶設為已簽到！`);
                        button.prop('disabled', false).text(originalText);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error batch checking in users:', error);
                        showAlert('danger', '批量簽到失敗，請重試。');
                        button.prop('disabled', false).text(originalText);
                    }
                });
            }
        });

        // Add inline editing functionality
        $('#usersTable tbody').on('dblclick', 'td:not(:last-child):not(:nth-last-child(2)):not(:first-child)', function() {
            const cell = $(this);
            const currentText = cell.text().trim();
            const fieldName = cell.data('field-name'); // 從 data-field-name 屬性獲取欄位名稱
            const row = cell.closest('tr');
            const userId = row.data('id');
            
            // 如果沒有 field-name 屬性，跳過編輯
            if (!fieldName) {
                console.log('No field-name attribute found for this cell');
                return;
            }
            
            // Create input field
            const input = $('<input>', {
                type: 'text',
                value: currentText,
                class: 'form-control form-control-sm'
            });
            
            // Replace cell content with input
            cell.html(input);
            input.focus();
            
            // Handle input events
            input.on('blur keypress', function(e) {
                if (e.type === 'blur' || e.which === 13) { // Enter key or blur
                    const newValue = input.val();
                    cell.text(newValue);
                    
                    // Send update to server
                    updateUserField(userId, fieldName, newValue);
                }
            });
        });
        
        // Function to update user field
        function updateUserField(userId, fieldName, newValue) {
            if (!fieldName) {
                console.log('No field name provided');
                return;
            }
            
            console.log('Updating field:', fieldName, 'with value:', newValue, 'for user:', userId);
            
            $.ajax({
                url: `/events/<%= event._id %>/users/${userId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ [fieldName]: newValue }),
                success: function(response) {
                    console.log('Update successful:', response);
                    showAlert('success', 'User updated successfully!');
                },
                error: function(xhr) {
                    console.error('Update failed:', xhr.responseText);
                    showAlert('danger', 'Update failed: ' + xhr.responseText);
                }
            });
        }
        
        // Function to show alerts
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('#alertContainer').append(alertHtml);
            setTimeout(() => {
                $('.alert').alert('close');
            }, 1500);
        }

        // Delete user functionality
        $('#usersTable tbody').on('click', '.delete-user', function() {
            const _id = $(this).data('_id');
            const event_id = '<%= event._id %>';

            if (confirm('Are you sure you want to delete this user?')) {
                $.ajax({
                    url: `/events/${event_id}/users/${_id}`,
                    type: 'DELETE',
                    success: function(response) {
                        $(this).closest('tr').remove();
                        showAlert('success', 'User deleted successfully!');
                    }.bind(this),
                    error: function(xhr, status, error) {
                        console.error('Error deleting user:', error);
                        showAlert('danger', 'Delete failed, please try again.');
                    }
                });
            }
        });

        // Use event delegation to listen for checkbox changes
        $('#usersTable tbody').on('change', '.checkin-toggle', function() {
            const row = $(this).closest('tr');
            const _id = row.data('id');
            const isCheckIn = $(this).is(':checked');
            const event_id = '<%= event._id %>';

            // Send AJAX request to update isCheckIn
            $.ajax({
                url: `/events/${event_id}/users/${_id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ isCheckIn: isCheckIn }),
                success: function(response) {
                    // Update row color
                    if (isCheckIn) {
                        row.removeClass('checkin-false').addClass('checkin-true');
                    } else {
                        row.removeClass('checkin-true').addClass('checkin-false');
                    }

                    // Show success alert
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            Update successful!
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    `;
                    $('#alertContainer').append(alertHtml);
                    // Auto-hide alert
                    setTimeout(() => {
                        $('.alert').alert('close');
                    }, 1500);
                },
                error: function(xhr, status, error) {
                    console.error('Error updating user:', error);
                    alert('Update failed, please try again later.');
                }
            });
        });



        // Get eventId
        const eventId = '<%= event._id %>';
        // Initialize ticket data
        let paymentTickets = <%- JSON.stringify(event.PaymentTickets || []) %>;
        let isPaymentEvent = <%- event.isPaymentEvent ? 'true' : 'false' %>;

        // Payment Event checkbox status initialization
        $('#paymentEvent').prop('checked', isPaymentEvent);
        if(isPaymentEvent) showTicketFields();

        // Dynamically display ticket fields
        function showTicketFields() {
            if($('#ticketFields').length) return;
            const html = `
                <form id="paymentEventForm" class="mt-3">
                    <h5>Ticket Settings</h5>
                    <div id="ticketsList"></div>
                    <button type="button" class="btn btn-primary btn-sm" id="addTicketBtn">Add Ticket</button>
                    <button type="submit" class="btn btn-success btn-sm ml-2">Save Payment Settings</button>
                </form>
            `;
            $('#paymentEvent').closest('.form-check').after(html);
            renderTickets();
        }

        // 渲染票券列表
        function renderTickets() {
            let html = '';
            paymentTickets.forEach((ticket, idx) => {
                html += `
                    <div class="ticket-item mb-2" data-idx="${idx}">
                        <input type="text" class="form-control d-inline-block w-auto mr-2 ticket-title" placeholder="票券名稱" value="${ticket.title || ''}" style="width:120px;">
                        <input type="number" class="form-control d-inline-block w-auto mr-2 ticket-price" placeholder="價格" value="${ticket.price || ''}" style="width:100px;">
                        <input type="datetime-local" class="form-control d-inline-block w-auto mr-2 ticket-datetime" value="${ticket.datetime ? new Date(ticket.datetime).toISOString().slice(0,16) : ''}" style="width:180px;">
                        <button type="button" class="btn btn-danger btn-sm remove-ticket">刪除</button>
                    </div>
                `;
            });
            $('#ticketsList').html(html);
        }

        // 新增票券
        $(document).on('click', '#addTicketBtn', function(e) {
            e.preventDefault();
            paymentTickets.push({ title: '', price: '', datetime: '' });
            renderTickets();
        });

        // 刪除票券
        $(document).on('click', '.remove-ticket', function() {
            const idx = $(this).closest('.ticket-item').data('idx');
            paymentTickets.splice(idx, 1);
            renderTickets();
        });

        // 編輯票券
        $(document).on('change', '.ticket-title, .ticket-price, .ticket-datetime', function() {
            const idx = $(this).closest('.ticket-item').data('idx');
            const row = $(this).closest('.ticket-item');
            paymentTickets[idx].title = row.find('.ticket-title').val();
            paymentTickets[idx].price = Number(row.find('.ticket-price').val());
            paymentTickets[idx].datetime = row.find('.ticket-datetime').val();
        });

        // 提交 payment event form
        $(document).on('submit', '#paymentEventForm', function(e) {
            e.preventDefault();
            const checked = $('#paymentEvent').is(':checked');
            $.ajax({
                url: `/events/${eventId}/paymentEvent`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({ isPaymentEvent: checked, PaymentTickets: paymentTickets }),
                success: function(res) {
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            付費活動設定已更新！
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    `;
                    $('#alertContainer').append(alertHtml);
                    setTimeout(() => { $('.alert').alert('close'); }, 1500);
                }
            });
        });

        // Add User functionality
        $('#addUserBtn').on('click', function() {
            $('#addUserForm').show();
            $(this).hide();
        });

        $('#cancelAddUser').on('click', function() {
            $('#addUserForm').hide();
            $('#addUserBtn').show();
            $('#newUserForm')[0].reset();
        });

        $('#newUserForm').on('submit', function(e) {
            e.preventDefault();
            
            // 動態收集表單數據
            const userData = {
                isCheckIn: false
            };
            
            $('#newUserForm').find('input, select, textarea').each(function() {
                const fieldName = $(this).attr('name');
                if (fieldName) {
                    userData[fieldName] = $(this).val();
                }
            });

            $.ajax({
                url: `/events/<%= event._id %>/users`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function(response) {
                    // Add new row to DataTable
                    // 動態構建新行數據
                    const newRow = [
                        '<input type="checkbox" class="user-select" data-_id="' + response._id + '" />'
                    ];
                    
                    // 根據formConfig添加字段數據
                    const fieldNames = []; // 用於記錄欄位名稱順序
                    <% if (formConfig && formConfig.sections) { %>
                        <% formConfig.sections.forEach(section => { %>
                            <% if (section.visible && section.fields) { %>
                                <% section.fields.forEach(field => { %>
                                    <% if (field.visible) { %>
                                        fieldNames.push('<%= field.fieldName %>');
                                        newRow.push(userData['<%= field.fieldName %>'] || '-');
                                    <% } %>
                                <% }); %>
                            <% } %>
                        <% }); %>
                    <% } else { %>
                        // 預設字段
                        fieldNames.push('email');
                        fieldNames.push('name');
                        fieldNames.push('company');
                        fieldNames.push('phone');
                        newRow.push(userData.email || '-');
                        newRow.push(userData.name || '-');
                        newRow.push(userData.company || '-');
                        newRow.push(userData.phone || '-');
                    <% } %>
                    
                    // 添加Checked In和Actions列
                    newRow.push('<input type="checkbox" class="checkin-toggle" data-_id="' + response._id + '" />');
                    newRow.push('<div class="user-action-buttons"><button class="btn btn-outline-primary resend-email" data-_id="' + response._id + '" title="Resend welcome email"><i class="fa fa-envelope mr-1"></i> Resend Welcome Email</button><button class="btn btn-danger delete-user" data-_id="' + response._id + '">Delete</button></div>');
                    
                    const rowNode = table.row.add(newRow).draw().node();
                    $(rowNode).addClass('checkin-false').attr('data-id', response._id);
                    
                    // 為新行的每個數據欄位設置 data-field-name 屬性
                    // 跳過第一個 checkbox 列、Checked In 列和 Actions 列
                    $(rowNode).find('td').each(function(index) {
                        if (index > 0 && index <= fieldNames.length) {
                            $(this).attr('data-field-name', fieldNames[index - 1]);
                        }
                    });
                    
                    // Hide form and show button
                    $('#addUserForm').hide();
                    $('#addUserBtn').show();
                    $('#newUserForm')[0].reset();
                    
                    showAlert('success', 'User added successfully!');
                },
                error: function(xhr, status, error) {
                    console.error('Error adding user:', error);
                    showAlert('danger', 'Failed to add user. Please try again.');
                }
            });
        });

        // 監聽 Payment Event checkbox，顯示/隱藏票券欄位
        $('#paymentEvent').on('change', function() {
            const checked = $(this).is(':checked');
            if(checked) {
                showTicketFields();
            } else {
                $('#paymentEventForm').remove();
                // 立即保存取消支付的設定
                $.ajax({
                    url: `/events/${eventId}/paymentEvent`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({ isPaymentEvent: false, PaymentTickets: [] }),
                    success: function(res) {
                        const alertHtml = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                已取消付費活動設定！
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        `;
                        $('#alertContainer').append(alertHtml);
                        setTimeout(() => { $('.alert').alert('close'); }, 1500);
                    },
                    error: function(error) {
                        console.error('取消付費設定失敗:', error);
                        // 如果保存失敗，重新勾選 checkbox
                        $('#paymentEvent').prop('checked', true);
                        showTicketFields();
                        const alertHtml = `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                取消付費設定失敗，請重試！
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        `;
                        $('#alertContainer').append(alertHtml);
                    }
                });
            }
        });
    });
</script>

</body>
</html>

