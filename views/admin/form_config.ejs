<%- include ("components/header") %>
<%- include ("components/menu", {eventId: event._id}) %>
<link rel="stylesheet" href="/admin/assets/css/cs-skin-elastic.css">
<link rel="stylesheet" href="/admin/assets/css/lib/datatable/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="/admin/assets/css/style.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .form-section {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 20px;
        background-color: #f8f9fa;
    }
    .field-item {
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 15px;
        padding: 15px;
        background-color: white;
    }
    .field-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .section-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .hidden-field {
        opacity: 0.5;
    }
    .hidden-section {
        opacity: 0.3;
    }
</style>
<div id="right-panel" class="right-panel">
    <%- include ("components/rightpanel_header") %>
    <div class="content">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <strong class="card-title">表單配置管理 - <%= event.name %></strong>
                            <div class="btn-toolbar mb-2 mb-md-0" style="float: right;">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetToDefault()">
                                        <i class="fas fa-undo"></i> 重置為預設
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="saveConfig()">
                                        <i class="fas fa-save"></i> 儲存配置
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 事件信息 -->
                            <div class="alert alert-info">
                                <h5><%= event.name %></h5>
                                <p class="mb-0">配置此事件的註冊表單字段顯示設定</p>
                            </div>

                            <!-- 表單配置區域 -->
                            <div id="formConfigContainer">
                                <% if (formConfig && formConfig.sections) { %>
                                    <% formConfig.sections.forEach((section, sectionIndex) => { %>
                                        <div class="form-section <%= section.visible ? '' : 'hidden-section' %>" data-section-index="<%= sectionIndex %>">
                                            <div class="section-controls">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" 
                                                           <%= section.visible ? 'checked' : '' %>
                                                           onchange="toggleSection(<%= sectionIndex %>)">
                                                    <label class="form-check-label">
                                                        <strong><%= section.sectionTitle %></strong>
                                                    </label>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSection(<%= sectionIndex %>)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            
                                            <% if (section.fields) { %>
                                                <% section.fields.forEach((field, fieldIndex) => { %>
                                                    <div class="field-item <%= field.visible ? '' : 'hidden-field' %>" data-field-index="<%= fieldIndex %>">
                                                        <div class="field-controls">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" 
                                                                       <%= field.visible ? 'checked' : '' %>
                                                                       onchange="toggleField(<%= sectionIndex %>, <%= fieldIndex %>)">
                                                                <label class="form-check-label">
                                                                    <strong><%= field.label %></strong>
                                                                    <% if (field.required) { %>
                                                                        <span class="text-danger">*</span>
                                                                    <% } %>
                                                                </label>
                                                            </div>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField(<%= sectionIndex %>, <%= fieldIndex %>)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        
                                                        <div class="row">
                                                            <div class="col-md-3">
                                                                <label class="form-label">字段名稱</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       value="<%= field.fieldName %>" 
                                                                       onchange="updateFieldProperty(<%= sectionIndex %>, <%= fieldIndex %>, 'fieldName', this.value)">
                                                            </div>
                                                            <div class="col-md-3">
                                                                <label class="form-label">顯示標籤</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       value="<%= field.label %>" 
                                                                       onchange="updateFieldProperty(<%= sectionIndex %>, <%= fieldIndex %>, 'label', this.value)">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label class="form-label">字段類型</label>
                                                                <select class="form-select form-select-sm" 
                                                                        onchange="updateFieldProperty(<%= sectionIndex %>, <%= fieldIndex %>, 'type', this.value)">
                                                                    <option value="text" <%= field.type === 'text' ? 'selected' : '' %>>文字</option>
                                                                    <option value="email" <%= field.type === 'email' ? 'selected' : '' %>>電子郵件</option>
                                                                    <option value="tel" <%= field.type === 'tel' ? 'selected' : '' %>>電話</option>
                                                                    <option value="select" <%= field.type === 'select' ? 'selected' : '' %>>下拉選單</option>
                                                                    <option value="textarea" <%= field.type === 'textarea' ? 'selected' : '' %>>多行文字</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label class="form-label">必填</label>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" 
                                                                           <%= field.required ? 'checked' : '' %>
                                                                           onchange="updateFieldProperty(<%= sectionIndex %>, <%= fieldIndex %>, 'required', this.checked)">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label class="form-label">排序</label>
                                                                <input type="number" class="form-control form-control-sm" 
                                                                       value="<%= field.order %>" 
                                                                       onchange="updateFieldProperty(<%= sectionIndex %>, <%= fieldIndex %>, 'order', parseInt(this.value))">
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="row mt-2">
                                                            <div class="col-md-6">
                                                                <label class="form-label">佔位符文字</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       value="<%= field.placeholder || '' %>" 
                                                                       onchange="updateFieldProperty(<%= sectionIndex %>, <%= fieldIndex %>, 'placeholder', this.value)">
                                                            </div>
                                                        </div>
                                                        
                                                        <% if (field.type === 'select' && field.options) { %>
                                                            <div class="mt-2">
                                                                <label class="form-label">選項設定</label>
                                                                <div id="options-<%= sectionIndex %>-<%= fieldIndex %>">
                                                                    <% field.options.forEach((option, optionIndex) => { %>
                                                                        <div class="input-group mb-1">
                                                                            <input type="text" class="form-control form-control-sm" 
                                                                                   placeholder="選項值" value="<%= option.value %>"
                                                                                   onchange="updateOption(<%= sectionIndex %>, <%= fieldIndex %>, <%= optionIndex %>, 'value', this.value)">
                                                                            <input type="text" class="form-control form-control-sm" 
                                                                                   placeholder="顯示文字" value="<%= option.label %>"
                                                                                   onchange="updateOption(<%= sectionIndex %>, <%= fieldIndex %>, <%= optionIndex %>, 'label', this.value)">
                                                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                                    onclick="removeOption(<%= sectionIndex %>, <%= fieldIndex %>, <%= optionIndex %>)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    <% }); %>
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                        onclick="addOption(<%= sectionIndex %>, <%= fieldIndex %>)">
                                                                    <i class="fas fa-plus"></i> 添加選項
                                                                </button>
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                <% }); %>
                                            <% } %>
                                            
                                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" 
                                                    onclick="addField(<%= sectionIndex %>)">
                                                <i class="fas fa-plus"></i> 添加字段
                                            </button>
                                        </div>
                                    <% }); %>
                                <% } %>
                            </div>

                            <!-- 添加新區塊按鈕 -->
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-primary" onclick="addSection()">
                                    <i class="fas fa-plus"></i> 添加新區塊
                                </button>
                            </div>

                            <!-- 預覽區域 -->
                            <div class="mt-4">
                                <h5>表單預覽</h5>
                                <div class="border p-3 bg-light">
                                    <div id="formPreview">
                                        <!-- 預覽內容將在這裡動態生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 載入腳本 -->
<script src="/admin/assets/js/vendor/jquery-2.1.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let formConfig = <%- JSON.stringify(formConfig) %>;
    const eventId = '<%= event._id %>';

    // 更新字段屬性
    function updateFieldProperty(sectionIndex, fieldIndex, property, value) {
        if (formConfig.sections[sectionIndex] && formConfig.sections[sectionIndex].fields[fieldIndex]) {
            formConfig.sections[sectionIndex].fields[fieldIndex][property] = value;
            updatePreview();
        }
    }

    // 更新選項
    function updateOption(sectionIndex, fieldIndex, optionIndex, property, value) {
        if (formConfig.sections[sectionIndex] && 
            formConfig.sections[sectionIndex].fields[fieldIndex] &&
            formConfig.sections[sectionIndex].fields[fieldIndex].options[optionIndex]) {
            formConfig.sections[sectionIndex].fields[fieldIndex].options[optionIndex][property] = value;
        }
    }

    // 添加選項
    function addOption(sectionIndex, fieldIndex) {
        if (!formConfig.sections[sectionIndex].fields[fieldIndex].options) {
            formConfig.sections[sectionIndex].fields[fieldIndex].options = [];
        }
        formConfig.sections[sectionIndex].fields[fieldIndex].options.push({
            value: '',
            label: ''
        });
        location.reload();
    }

    // 移除選項
    function removeOption(sectionIndex, fieldIndex, optionIndex) {
        formConfig.sections[sectionIndex].fields[fieldIndex].options.splice(optionIndex, 1);
        location.reload();
    }

    // 切換字段顯示
    function toggleField(sectionIndex, fieldIndex) {
        const field = formConfig.sections[sectionIndex].fields[fieldIndex];
        field.visible = !field.visible;
        
        const fieldElement = document.querySelector('[data-section-index="' + sectionIndex + '"] [data-field-index="' + fieldIndex + '"]');
        if (field.visible) {
            fieldElement.classList.remove('hidden-field');
        } else {
            fieldElement.classList.add('hidden-field');
        }
        updatePreview();
    }

    // 切換區塊顯示
    function toggleSection(sectionIndex) {
        const section = formConfig.sections[sectionIndex];
        section.visible = !section.visible;
        
        const sectionElement = document.querySelector('[data-section-index="' + sectionIndex + '"]');
        if (section.visible) {
            sectionElement.classList.remove('hidden-section');
        } else {
            sectionElement.classList.add('hidden-section');
        }
        updatePreview();
    }

    // 添加字段
    function addField(sectionIndex) {
        const newField = {
            fieldName: 'new_field',
            label: '新字段',
            type: 'text',
            required: false,
            visible: true,
            placeholder: '',
            order: formConfig.sections[sectionIndex].fields.length + 1
        };
        formConfig.sections[sectionIndex].fields.push(newField);
        location.reload();
    }

    // 移除字段
    function removeField(sectionIndex, fieldIndex) {
        if (confirm('確定要刪除此字段嗎？')) {
            formConfig.sections[sectionIndex].fields.splice(fieldIndex, 1);
            location.reload();
        }
    }

    // 添加區塊
    function addSection() {
        const newSection = {
            sectionName: 'new_section',
            sectionTitle: '新區塊',
            visible: true,
            order: formConfig.sections.length + 1,
            fields: []
        };
        formConfig.sections.push(newSection);
        location.reload();
    }

    // 移除區塊
    function removeSection(sectionIndex) {
        if (confirm('確定要刪除此區塊嗎？')) {
            formConfig.sections.splice(sectionIndex, 1);
            location.reload();
        }
    }

    // 更新預覽
    function updatePreview() {
        const preview = document.getElementById('formPreview');
        let html = '';
        
        formConfig.sections.forEach(function(section) {
            if (section.visible) {
                html += '<div class="form-section-preview mb-3">';
                html += '<h5>' + section.sectionTitle + '</h5>';
                
                section.fields.forEach(function(field) {
                    if (field.visible) {
                        html += '<div class="mb-2">';
                        html += '<label class="form-label">' + field.label;
                        if (field.required) html += ' <span class="text-danger">*</span>';
                        html += '</label>';
                        
                        if (field.type === 'select' && field.options) {
                            html += '<select class="form-select" disabled>';
                            html += '<option>--- 請選擇 ---</option>';
                            field.options.forEach(function(option) {
                                html += '<option value="' + option.value + '">' + option.label + '</option>';
                            });
                            html += '</select>';
                        } else if (field.type === 'textarea') {
                            html += '<textarea class="form-control" placeholder="' + (field.placeholder || '') + '" disabled></textarea>';
                        } else {
                            html += '<input type="' + field.type + '" class="form-control" placeholder="' + (field.placeholder || '') + '" disabled>';
                        }
                        html += '</div>';
                    }
                });
                
                html += '</div>';
            }
        });
        
        preview.innerHTML = html;
    }

    // 儲存配置
    async function saveConfig() {
        try {
            const response = await fetch('/formConfig/' + eventId + '/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sections: formConfig.sections })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('表單配置已儲存！');
            } else {
                alert('儲存失敗：' + result.message);
            }
        } catch (error) {
            alert('儲存失敗：' + error.message);
        }
    }

    // 重置為預設
    async function resetToDefault() {
        if (confirm('確定要重置為預設配置嗎？這將覆蓋所有現有設定。')) {
            try {
                const response = await fetch('/formConfig/' + eventId + '/reset', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('已重置為預設配置！');
                    location.reload();
                } else {
                    alert('重置失敗：' + result.message);
                }
            } catch (error) {
                alert('重置失敗：' + error.message);
            }
        }
    }

    // 初始化預覽
    updatePreview();
</script>

<%- include ("components/footer") %>