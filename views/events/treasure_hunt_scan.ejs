<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt - å°‹å¯¶æƒæ</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .scan-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        .scan-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #333;
        }
        #reader {
            width: 100% !important;
            max-width: 400px;
            margin: 20px auto !important;
            text-align: center !important;
        }
        #reader > div {
            margin: 0 auto !important;
            text-align: center !important;
            display: inline-block !important;
        }
        #reader video {
            margin: 0 auto !important;
            display: block !important;
            max-width: 100% !important;
            transform: none !important;
        }
        /* éš±è— qr-canvasï¼Œåªé¡¯ç¤º video */
        #reader canvas#qr-canvas,
        #reader canvas {
            display: none !important;
        }
        #reader__dashboard,
        #reader__camera_selection {
            margin: 0 auto !important;
            text-align: center !important;
        }
        #reader__scan_region {
            margin: 0 auto !important;
            text-align: center !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        #reader__scan_region video {
            margin: 0 auto !important;
            display: block !important;
        }
        /* ç¢ºä¿åªæœ‰ä¸€å€‹ video é¡¯ç¤º */
        #reader video {
            position: relative !important;
            z-index: 1 !important;
        }
        .btn-scan {
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            border-radius: 8px;
        }
        .success-message {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            color: #155724;
            border-radius: 8px;
            display: none;
        }
        .error-message {
            margin-top: 20px;
            padding: 15px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            display: none;
        }
        .success-message.show,
        .error-message.show {
            display: block;
        }
        .points-display {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin-top: 10px;
        }
        .item-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .history-section {
            margin-top: 30px;
            text-align: left;
        }
        .history-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .history-item {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item-name {
            font-weight: 500;
            color: #333;
        }
        .history-item-points {
            color: #28a745;
            font-weight: bold;
        }
        .current-points {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="scan-container">
    <h2 class="scan-title">ğŸ´â€â˜ ï¸ Treasure Hunt å°‹å¯¶éŠæˆ²</h2>
    <p class="lead">æƒæ QR Code ç²å–ç©åˆ†ï¼</p>
    
    <div class="current-points" style="text-align: center;">
        ç•¶å‰ç©åˆ†ï¼š<span id="currentPointsDisplay"><%= userPoints %></span>
    </div>
    
    <div style="text-align: center; margin: 20px 0;">
        <button id="startScanBtn" class="btn btn-primary btn-scan">æ‰“é–‹é¡é ­æƒæ</button>
        <button id="stopScanBtn" class="btn btn-danger btn-scan" style="display: none;">åœæ­¢æƒæ</button>
    </div>
    
    <div id="reader" style="display: none;"></div>
    
    <div id="successMessage" class="success-message"></div>
    <div id="errorMessage" class="error-message"></div>
    
    <div id="itemInfo" class="item-info" style="display: none;">
        <h4 id="itemName"></h4>
        <p class="points-display" id="itemPoints"></p>
    </div>
    
    <% if (scanHistory && scanHistory.length > 0) { %>
    <div class="history-section">
        <h3 class="history-title">ğŸ“‹ éå¾€å¾—åˆ†è¨˜éŒ„</h3>
        <div id="historyList">
            <% scanHistory.forEach(function(history) { %>
            <div class="history-item">
                <span class="history-item-name"><%= history.name %></span>
                <span class="history-item-points">+<%= history.points %> ç©åˆ†</span>
            </div>
            <% }); %>
        </div>
    </div>
    <% } else { %>
    <div class="history-section">
        <h3 class="history-title">ğŸ“‹ éå¾€å¾—åˆ†è¨˜éŒ„</h3>
        <p style="color: #666; text-align: center;">é‚„æ²’æœ‰æƒæè¨˜éŒ„</p>
    </div>
    <% } %>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script>
    const eventId = '<%= eventId %>';
    const html5QrCode = new Html5Qrcode("reader");
    let scanning = false;
    
    // å¾å¾Œç«¯å‚³éçš„ userId æˆ– URL åƒæ•¸ç²å–ç•¶å‰ç”¨æˆ¶ ID
    let currentUserId = '<%= typeof userId !== "undefined" ? userId : "" %>';
    
    // å¦‚æœæ²’æœ‰ï¼Œå˜—è©¦å¾ URL åƒæ•¸ç²å–
    if (!currentUserId) {
        const urlParams = new URLSearchParams(window.location.search);
        currentUserId = urlParams.get('userId');
    }
    
    // å¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œæç¤ºç”¨æˆ¶ç™»å…¥
    if (!currentUserId) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        window.location.href = `/events/${eventId}/login`;
    }

    const startScanBtn = document.getElementById('startScanBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const readerDiv = document.getElementById('reader');
    const successMessageDiv = document.getElementById('successMessage');
    const errorMessageDiv = document.getElementById('errorMessage');
    const itemInfoDiv = document.getElementById('itemInfo');

    function showError(message) {
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.add('show');
        successMessageDiv.classList.remove('show');
        setTimeout(() => {
            errorMessageDiv.classList.remove('show');
        }, 5000);
    }

    function showSuccess(message, itemName, points) {
        successMessageDiv.innerHTML = message;
        successMessageDiv.classList.add('show');
        errorMessageDiv.classList.remove('show');
        
        if (itemName && points) {
            document.getElementById('itemName').textContent = itemName;
            document.getElementById('itemPoints').textContent = `+${points} ç©åˆ†`;
            itemInfoDiv.style.display = 'block';
        }
        
        setTimeout(() => {
            successMessageDiv.classList.remove('show');
            itemInfoDiv.style.display = 'none';
        }, 5000);
    }

    async function startScanner() {
        if (scanning) return;
        
        if (!currentUserId) {
            showError('è«‹å…ˆç™»å…¥ï¼');
            setTimeout(() => {
                window.location.href = `/events/${eventId}/login`;
            }, 2000);
            return;
        }
        
        try {
            startScanBtn.disabled = true;
            readerDiv.style.display = 'block';
            
            await html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                },
                (decodedText, decodedResult) => {
                    handleQRCodeScan(decodedText);
                },
                (errorMessage) => {
                    // æƒæéŒ¯èª¤æ™‚ä¸é¡¯ç¤ºï¼Œå› ç‚ºæœƒä¸€ç›´è§¸ç™¼
                }
            );
            
            // å•Ÿå‹•å¾Œéš±è— canvasï¼Œåªé¡¯ç¤º video
            setTimeout(() => {
                const reader = document.getElementById('reader');
                if (reader) {
                    const canvases = reader.querySelectorAll('canvas#qr-canvas, canvas');
                    canvases.forEach(canvas => {
                        canvas.style.display = 'none';
                    });
                }
            }, 200);
            
            scanning = true;
            startScanBtn.style.display = 'none';
            stopScanBtn.style.display = 'inline-block';
        } catch (error) {
            console.error('Error starting scanner:', error);
            showError('ç„¡æ³•å•Ÿå‹•æƒæå™¨ï¼š' + error.message);
            startScanBtn.disabled = false;
            readerDiv.style.display = 'none';
        }
    }

    async function stopScanner() {
        if (!scanning) return;
        
        try {
            await html5QrCode.stop();
            scanning = false;
            startScanBtn.style.display = 'inline-block';
            stopScanBtn.style.display = 'none';
            readerDiv.style.display = 'none';
            startScanBtn.disabled = false;
        } catch (error) {
            console.error('Error stopping scanner:', error);
        }
    }

    function handleQRCodeScan(decodedText) {
        if (!scanning || !currentUserId) return;
        
        // åœæ­¢æƒæ
        stopScanner();
        
        // ç™¼é€æƒæè«‹æ±‚
        fetch(`/events/${eventId}/treasure-hunt/scan`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                qrCodeData: decodedText,
                userId: currentUserId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ›´æ–°ç•¶å‰ç©åˆ†é¡¯ç¤º
                document.getElementById('currentPointsDisplay').textContent = data.user.currentPoints;
                
                // æ·»åŠ æ–°çš„è¨˜éŒ„åˆ°æ­·å²åˆ—è¡¨
                const historyList = document.getElementById('historyList');
                if (historyList) {
                    const newHistoryItem = document.createElement('div');
                    newHistoryItem.className = 'history-item';
                    newHistoryItem.innerHTML = `
                        <span class="history-item-name">${data.item.name}</span>
                        <span class="history-item-points">+${data.item.points} ç©åˆ†</span>
                    `;
                    // æ’å…¥åˆ°åˆ—è¡¨æœ€å‰é¢
                    historyList.insertBefore(newHistoryItem, historyList.firstChild);
                }
                
                showSuccess(
                    `ğŸ‰ ${data.message}<br>ç•¶å‰ç©åˆ†ï¼š${data.user.currentPoints}`,
                    data.item.name,
                    data.item.points
                );
            } else {
                showError(data.message || 'æƒæå¤±æ•—');
            }
        })
        .catch(error => {
            console.error('Error scanning QR code:', error);
            showError('æƒææ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
        });
    }

    startScanBtn.addEventListener('click', startScanner);
    stopScanBtn.addEventListener('click', stopScanner);

    // é é¢å¸è¼‰æ™‚åœæ­¢æƒæ
    window.addEventListener('beforeunload', async () => {
        await stopScanner();
    });
</script>

</body>
</html>

