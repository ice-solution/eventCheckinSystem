<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>äº’å‹•æŠ½ç</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      height:100vh;
      overflow-y:scroll;
      overflow-x:hidden;
      margin: 0;
      /* background: rgb(0, 46, 93); */
    }
    .bg {
      background-image: url('/luckydraw/img/<%= eventId %>.jpg'); /* ä½¿ç”¨äº‹ä»¶ ID ä½œç‚ºèƒŒæ™¯åœ–ç‰‡ */
      background-size: cover; /* ä½¿èƒŒæ™¯åœ–ç‰‡è¦†è“‹æ•´å€‹ç•«é¢ */
      background-position: center; /* ä½¿èƒŒæ™¯åœ–ç‰‡å±…ä¸­ */
      padding: 120px;
      height:100vh;
    }

    .container {
      display: flex;
      align-items: flex-start;
      gap: 30px;
    }

    #result {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      gap: 10px;
      margin-top: 30px; /* å¢åŠ ä¸Šé‚Šè·ä»¥å‘ä¸‹ç§»å‹• result */
    }

    .rets {
      display: flex;
      align-items: center; /* å‚ç›´å±…ä¸­ */
      background-color: #ffeeba;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      transition: 0.3s;
      width: calc(25% - 10px); /* ä½¿å…¶ä½”æ»¿çˆ¶å®¹å™¨ï¼Œå››å€‹ä¸€è¡Œ */
    }

    .rets:hover {
      background-color: #ffe08a;
    }

    .number {
      width: 30px; /* æ§åˆ¶åºè™Ÿçš„å¯¬åº¦ */
      text-align: center;
      font-weight: bold;
      margin-right: 10px; /* èˆ‡å¡ç‰‡å…§å®¹çš„é–“è· */
    }

    .card {
      flex-grow: 1; /* ä½¿å¡ç‰‡ä½”æ»¿å‰©é¤˜ç©ºé–“ */
    }

    .name {
      font-weight: bold;
      font-size: 16px;
    }

    .company {
      font-size: 13px;
      color: #555;
      margin-top: 3px;
    }

    .table {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .prize {
      font-size: 14px;
      font-weight: bold;
      color: #e74c3c;
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 4px;
      padding: 4px 8px;
      margin-bottom: 6px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #control {
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: fixed;
      right: 0;
      transform: translate(-50%,0%);
    }

    #startBtn, #draw5Btn, #draw10Btn {
      padding: 15px 20px;
      font-size: 16px;
      /* background-color: #28a745; */
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #startBtn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    #spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #ccc;
      border-top: 6px solid #28a745;
      border-radius: 50%;
      animation: spin 0.4s linear infinite;
      display: none;
      margin: 0 auto;
    }

    #current {
      font-size: 36px;
      font-weight: bold;
      color: black; /* æ–‡å­—é¡è‰²è¨­ç½®ç‚ºé»‘è‰² */
      text-align: center;
      margin-top: 150px;
      background-color: #ffeeba; /* èˆ‡ card ä¸€è‡´çš„èƒŒæ™¯ */
      border-radius: 6px; /* èˆ‡ card ä¸€è‡´çš„åœ“è§’ */
      padding: 50px; /* èˆ‡ card ä¸€è‡´çš„å…§é‚Šè· */
      width: 20%; /* èª¿æ•´å¯¬åº¦ */
      margin-left: auto; /* å±…ä¸­ */
      margin-right: auto; /* å±…ä¸­ */
      display: none; /* åˆå§‹éš±è— */
    }

    h1 {
      color: #000;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .animation {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 999;
    }

    .spinner {
      width: 150px; /* èª¿æ•´ç‚ºæ–°çš„ giftbox.gif å°ºå¯¸ */
      height: 150px; /* èª¿æ•´ç‚ºæ–°çš„ giftbox.gif å°ºå¯¸ */
      /* ç§»é™¤ CSS æ—‹è½‰å‹•ç•«ï¼Œå› ç‚º giftbox.gif æœ¬èº«å·²æœ‰å‹•ç•« */
    }

    /* ç§»é™¤ CSS æ—‹è½‰å‹•ç•«ï¼Œå› ç‚º giftbox.gif æœ¬èº«å·²æœ‰å‹•ç•« */
  </style>
  <!-- <link rel="stylesheet" href="/admin/assets/css/luckydraw.css"> -->
</head>
<body>

  <div class="bg">
    <div class="js-container  container">
      <div id="result"></div>

      <div id="control">
        <div id="prizeSelector" style="margin-bottom: 15px;">
          <label for="prizeSelect" style="color: white; font-weight: bold; display: block; margin-bottom: 5px;">é¸æ“‡çå“ï¼š</label>
          <select id="prizeSelect" style="width: 180px; padding: 8px; border-radius: 4px; margin-bottom: 10px;" required>
            <option value="">è«‹é¸æ“‡çå“</option>
            <% prizes.forEach(prize => { %>
              <% if (prize.unit > 0) { %>
                <option value="<%= prize._id %>" data-name="<%= prize.name %>"><%= prize.name %> (å‰©é¤˜: <%= prize.unit %>)</option>
              <% } %>
            <% }); %>
          </select>
        </div>
        <img id="startBtn" src="/admin/img/start.png" alt="start...">
        <button id="draw5Btn" style="padding: 15px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">é€£æŠ½5äºº</button>
        <!-- <button id="startBtn">1</button> -->
        <!-- <button id="draw10Btn">10</button> -->
        <div id="spinner"></div>
      </div>
    </div>

    <div id="current"></div>
    <div class="overlay" id="overlay"></div>
    <div class="animation" id="animation">
      <img src="/admin/img/giftbox.gif" alt="Loading..." class="spinner" id="spinnerImage">
    </div>
  </div> 

  <script>
    const allPeople = <%- JSON.stringify(availablePeople) %>; // å°‡ users è½‰æ›ç‚º JSON æ ¼å¼
    const eventId = '<%= eventId %>';

    let availablePeople = [...allPeople];
    const drawnPeople = [];
    
    const resultDiv = document.getElementById('result');
    const startBtn = document.getElementById('startBtn');
    const draw5Btn = document.getElementById('draw5Btn');
    const draw10Btn = document.getElementById('draw10Btn');
    const spinner = document.getElementById('spinner');
    const currentDiv = document.getElementById('current');
    const overlay = document.getElementById('overlay');
    const animationDiv = document.getElementById('animation');

    function drawWinner() {
      if (availablePeople.length === 0) {
        alert("æ‰€æœ‰äººéƒ½å·²æŠ½å‡ºï¼");
        return;
      }

      // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†çå“
      const prizeSelect = document.getElementById('prizeSelect');
      if (!prizeSelect.value) {
        alert("è«‹å…ˆé¸æ“‡çå“ï¼");
        return;
      }

      // å‹•æ…‹æª¢æŸ¥çå“åº«å­˜
      const selectedOption = prizeSelect.options[prizeSelect.selectedIndex];
      const currentText = selectedOption.text;
      const match = currentText.match(/\(å‰©é¤˜: (\d+)\)/);
      
      if (!match) {
        alert("ç„¡æ³•ç²å–çå“åº«å­˜ä¿¡æ¯ï¼");
        return;
      }

      const remainingPrize = parseInt(match[1]);
      if (remainingPrize <= 0) {
        alert("æ‰€é¸çå“å·²ç„¡åº«å­˜ï¼");
        return;
      }

      overlay.style.display = 'block';
      animationDiv.style.display = 'block';
      spinner.style.display = 'block';
      startBtn.disabled = true;

      setTimeout(() => {
        spinner.style.display = 'none';
        startBtn.disabled = false;

        const index = Math.floor(Math.random() * availablePeople.length);
        const person = availablePeople.splice(index, 1)[0];
        drawnPeople.push(person);

        // ç²å–é¸æ“‡çš„çå“ä¿¡æ¯ï¼ˆæå‰ç²å–ï¼‰
        const prizeSelect = document.getElementById('prizeSelect');
        const selectedPrizeId = prizeSelect.value;
        const selectedPrizeName = prizeSelect.options[prizeSelect.selectedIndex].dataset.name || '';
        
        // å°‡çå“ä¿¡æ¯å­˜å„²åˆ° person å°è±¡ä¸­
        person.prizeId = selectedPrizeId || null;
        person.prizeName = selectedPrizeName;

        const rets = document.createElement('div');
        rets.className = 'rets';
        rets.dataset.id = person._id;

        // é¡¯ç¤ºä¸­çè€…çš„åºè™Ÿ
        const winnerIndex = drawnPeople.length; // ç•¶å‰ä¸­çè€…çš„åºè™Ÿ
        // æ§‹å»ºé¡¯ç¤ºå…§å®¹ï¼Œè™•ç†ç©ºå€¼
        let displayContent = '';
        
        // æ·»åŠ çå“ä¿¡æ¯ï¼ˆåœ¨åå­—ä¸Šæ–¹ï¼‰
        if (person.prizeName) {
          displayContent += `<div class="prize">ğŸ ${person.prizeName}</div>`;
        }
        
        displayContent += `<div class="name">${person.name}</div>`;
        
        if (person.company) {
          displayContent += `<div class="company">${person.company}</div>`;
        }
        
        if (person.table) {
          displayContent += `<div class="table">æ¡Œè™Ÿ: ${person.table}</div>`;
        }
        
        rets.innerHTML = `<div class="number">${winnerIndex}</div><div class="card">${displayContent}</div>`;
        resultDiv.appendChild(rets);

        // é¡¯ç¤ºç•¶å‰ä¸­çè€…
        let currentDisplay = '';
        
        // æ·»åŠ çå“ä¿¡æ¯
        if (person.prizeName) {
          currentDisplay += `<div style="font-size: 24px; color: #e74c3c; font-weight: bold; margin-bottom: 10px;">ğŸ ${person.prizeName}</div>`;
        }
        
        currentDisplay += person.name;
        if (person.company) {
          currentDisplay += `<br>(${person.company})`;
        }
        if (person.table) {
          currentDisplay += `<br>æ¡Œè™Ÿ: ${person.table}`;
        }
        currentDiv.innerHTML = currentDisplay;
        currentDiv.style.display = 'block'; // é¡¯ç¤º current

        // é»æ“Šå¡ç‰‡ â†’ åˆªé™¤ç¢ºèª
        rets.addEventListener('click', () => {
          if (confirm(`ç¢ºå®šè¦å–æ¶ˆ ${person.name} çš„ä¸­ççµæœï¼Ÿ`)) {
            resultDiv.removeChild(rets);
            drawnPeople.splice(drawnPeople.findIndex(p => p._id === person._id), 1);
            availablePeople.push(person);

            // å¦‚æœé€™å€‹äººæœ‰æŒ‡å®šçå“ï¼Œéœ€è¦é‚„åŸçå“é¸é …çš„é¡¯ç¤º
            if (person.prizeId) {
              const prizeSelect = document.getElementById('prizeSelect');
              let option = Array.from(prizeSelect.options).find(opt => opt.value === person.prizeId);
              
              if (option) {
                // é¸é …å­˜åœ¨ï¼Œæ›´æ–°æ•¸é‡
                const currentText = option.text;
                const match = currentText.match(/\(å‰©é¤˜: (\d+)\)/);
                if (match) {
                  const remaining = parseInt(match[1]) + 1; // é‚„åŸæ•¸é‡
                  option.text = option.text.replace(/\(å‰©é¤˜: \d+\)/, `(å‰©é¤˜: ${remaining})`);
                }
              } else {
                // é¸é …ä¸å­˜åœ¨ï¼ˆè¢«ç§»é™¤äº†ï¼‰ï¼Œéœ€è¦é‡æ–°å‰µå»º
                const newOption = document.createElement('option');
                newOption.value = person.prizeId;
                newOption.dataset.name = person.prizeName || 'æœªçŸ¥çå“';
                newOption.text = `${person.prizeName || 'æœªçŸ¥çå“'} (å‰©é¤˜: 1)`;
                
                // æ’å…¥åˆ°ç¬¬ä¸€å€‹é¸é …ä¹‹å¾Œ
                if (prizeSelect.options.length > 1) {
                  prizeSelect.insertBefore(newOption, prizeSelect.options[1]);
                } else {
                  prizeSelect.appendChild(newOption);
                }
                
                console.log(`å·²é‡æ–°æ·»åŠ çå“é¸é …: ${person.prizeName} (å‰©é¤˜: 1)`);
              }
            }

            // DELETE API
            fetch(`/events/${eventId}/luckydraw`, { // ä½¿ç”¨ eventId
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ _id: person._id })
            })
            .then(res => {
              if (res.ok) {
                console.log("å·²åˆªé™¤", person);
              } else {
                console.error("åˆªé™¤å¤±æ•—", res.statusText);
              }
            })
            .catch(err => console.error("åˆªé™¤å¤±æ•—", err));
          }
        });

        // çå“ä¿¡æ¯å·²ç¶“åœ¨ä¸Šé¢ç²å–ä¸¦å­˜å„²åˆ° person å°è±¡ä¸­
        // æº–å‚™ç™¼é€çš„æ•¸æ“š
        const postData = {
          ...person,
          prizeId: person.prizeId
        };
        
        // POST è©²äººè³‡æ–™
        fetch(`/events/${eventId}/luckydraw`, { // ä½¿ç”¨ eventId
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        })
        .then(res => {
          if (res.ok) {
            console.log("å·²é€å‡º", person);
            // æ›´æ–°çå“é¸é …é¡¯ç¤º
            const option = prizeSelect.options[prizeSelect.selectedIndex];
            const currentText = option.text;
            const match = currentText.match(/\(å‰©é¤˜: (\d+)\)/);
            if (match) {
              const remaining = parseInt(match[1]) - 1;
              if (remaining <= 0) {
                option.remove(); // ç§»é™¤æ•¸é‡ç‚º0çš„é¸é …
                // é‡ç½®é¸æ“‡ç‚ºç¬¬ä¸€å€‹å¯ç”¨é¸é …
                if (prizeSelect.options.length > 1) {
                  prizeSelect.selectedIndex = 1;
                } else {
                  prizeSelect.selectedIndex = 0;
                }
              } else {
                option.text = option.text.replace(/\(å‰©é¤˜: \d+\)/, `(å‰©é¤˜: ${remaining})`);
              }
            }
          } else {
            console.error("é€å‡ºå¤±æ•—", res.statusText);
            // å¦‚æœé€å‡ºå¤±æ•—ï¼Œé‡æ–°å•Ÿç”¨æŒ‰éˆ•
            startBtn.disabled = false;
          }
        })
        .catch(err => console.error("é€å‡ºå¤±æ•—", err));

        overlay.style.display = 'none';
        animationDiv.style.display = 'none';
      }, 3000); // 3ç§’å¾Œé¡¯ç¤ºçµæœ
    }

    startBtn.addEventListener('click', drawWinner);

    draw5Btn.addEventListener('click', () => {
      // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†çå“
      const prizeSelect = document.getElementById('prizeSelect');
      if (!prizeSelect.value) {
        alert("è«‹å…ˆé¸æ“‡çå“ï¼");
        return;
      }

      // ç²å–ç•¶å‰é¸æ“‡çš„çå“ä¿¡æ¯
      const selectedPrizeId = prizeSelect.value;
      const selectedOption = prizeSelect.options[prizeSelect.selectedIndex];
      const currentText = selectedOption.text;
      const match = currentText.match(/\(å‰©é¤˜: (\d+)\)/);
      
      if (!match) {
        alert("ç„¡æ³•ç²å–çå“åº«å­˜ä¿¡æ¯ï¼");
        return;
      }

      const remainingPrize = parseInt(match[1]);
      const availablePeopleCount = availablePeople.length;
      
      // è¨ˆç®—å¯¦éš›å¯æŠ½å–çš„æ•¸é‡ï¼šå–æœ€å°å€¼ï¼ˆ5äººã€å¯ç”¨äººæ•¸ã€çå“åº«å­˜ï¼‰
      const drawCount = Math.min(5, availablePeopleCount, remainingPrize);
      
      if (drawCount <= 0) {
        if (availablePeopleCount === 0) {
          alert("æ‰€æœ‰äººéƒ½å·²æŠ½å‡ºï¼");
        } else if (remainingPrize === 0) {
          alert("æ‰€é¸çå“å·²ç„¡åº«å­˜ï¼");
        }
        return;
      }

      // é¡¯ç¤ºé€£æŠ½ä¿¡æ¯
      console.log(`é–‹å§‹é€£æŠ½ ${drawCount} äººï¼Œçå“åº«å­˜ï¼š${remainingPrize}ï¼Œå¯ç”¨äººæ•¸ï¼š${availablePeopleCount}`);

      // åŸ·è¡Œé€£æŠ½
      let currentDraw = 0;
      const executeDraw = () => {
        if (currentDraw >= drawCount) {
          return; // å·²å®Œæˆæ‰€æœ‰æŠ½ç
        }

        // é‡æ–°æª¢æŸ¥çå“åº«å­˜
        const prizeSelect = document.getElementById('prizeSelect');
        const selectedOption = prizeSelect.options[prizeSelect.selectedIndex];
        const currentText = selectedOption.text;
        const match = currentText.match(/\(å‰©é¤˜: (\d+)\)/);
        
        if (!match || parseInt(match[1]) <= 0) {
          console.log("çå“åº«å­˜ä¸è¶³ï¼Œåœæ­¢é€£æŠ½");
          return;
        }

        // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¯ç”¨äººå“¡
        if (availablePeople.length === 0) {
          console.log("æ²’æœ‰å¯ç”¨äººå“¡ï¼Œåœæ­¢é€£æŠ½");
          return;
        }

        drawWinner();
        currentDraw++;
        
        // å¦‚æœé‚„æœ‰å‰©é¤˜æŠ½çæ¬¡æ•¸ï¼Œç¹¼çºŒä¸‹ä¸€æ¬¡
        if (currentDraw < drawCount) {
          setTimeout(executeDraw, 3500); // 3.5ç§’å¾ŒåŸ·è¡Œä¸‹ä¸€æ¬¡æŠ½ç
        }
      };

      executeDraw();
    });

    draw10Btn.addEventListener('click', () => {
      const drawCount = Math.min(10, availablePeople.length); // ç¢ºä¿æœ€å¤šæŠ½å–å¯ç”¨äººæ•¸
      for (let i = 0; i < drawCount; i++) {
        drawWinner();
      }
    });
  </script>
  <!-- <script src="/admin/assets/js/luckydraw.js"></script> -->
</body>
</html>
