<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>ç”¨æˆ¶è³‡æ–™</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            background-color: rgb(0, 46, 93);
        }
        .profile-container {
            margin-top: 50px;
            padding: 20px;
            border-radius: 10px;
            background: white;
            /* background-image:url('/admin/img/ticket_bg.png'); */
            background-size:cover;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 100px;
            justify-content:center;
            margin-top:120px;
        }
        .profile-header img {
            border-radius: 50%;
            width: 100px;
            height: 100px;
            margin-right: 20px;
        }
        .point-display {
            font-size: 1.5rem; /* å¢åŠ å­—é«”å¤§å° */
            text-align: center; /* ç½®ä¸­ */
            margin-bottom: 20px; /* å¢åŠ ä¸‹é‚Šè· */
        }
        h4 {
            display: flex;
            justify-content: center; /* ç½®ä¸­ QR ç¢¼ */
            margin-bottom: 20px; /* å¢åŠ ä¸‹é‚Šè· */
        }
        #qrcode {
            display: flex;
            justify-content: center; /* ç½®ä¸­ QR ç¢¼ */
            margin-bottom: 20px; /* å¢åŠ ä¸‹é‚Šè· */
            margin-left:30px;
        }
        /* Lightboxæ¨£å¼ */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .scanner-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #reader {
            width: 100% !important;
            max-width: 400px;
            margin: 20px auto !important;
            text-align: center !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        #reader > div {
            margin: 0 auto !important;
            text-align: center !important;
            width: 100% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        #reader video {
            margin: 0 auto !important;
            display: block !important;
            max-width: 100% !important;
            transform: none !important;
        }
        /* éš±è— qr-canvasï¼Œåªé¡¯ç¤º video */
        #reader canvas#qr-canvas,
        #reader canvas {
            display: none !important;
        }
        #reader__dashboard,
        #reader__camera_selection {
            margin: 0 auto !important;
            text-align: center !important;
        }
        #reader__scan_region {
            margin: 0 auto !important;
            text-align: center !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        #reader__scan_region video {
            margin: 0 auto !important;
            display: block !important;
        }
        /* ç¢ºä¿åªæœ‰ä¸€å€‹ video é¡¯ç¤º */
        #reader video {
            position: relative !important;
            z-index: 1 !important;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 profile-container">
            <div class="profile-header">
                <!-- <img src="https://picsum.photos/200" alt="ç”¨æˆ·å¤´åƒ"> -->
                <div>
                    <h2><%= user.name %></h2>
                    <p class="text-muted">Email: <%= user.email %></p>
                    <p class="text-muted"><%= user.isCheckIn ? 'å·² Check-in' : 'æœª Check-in' %>
                    </p>
                </div>
                <div id="qrcode" class="mb-4"></div>
            </div>
            <h4>å€‹äººè¨Šæ¯</h4>
            <ul class="list-group mb-4">
                <li class="list-group-item">Username: <span class="float-right"><%= user.name %></span></li>
                <li class="list-group-item">Phone: <span class="float-right"><%= user.phone %></span></li>
                <li class="list-group-item">Point: <span class="float-right"><%= user.point %></span></li>
            </ul>
            <h4>Scan QR Code</h4>
            
            <button id="loginQRCode" class="btn btn-primary mb-4">æƒæ QR ç¢¼ ç™»å…¥</button>
            <!-- <button id="scanPointQRCode" class="btn btn-secondary mb-4">æƒæ QR ç¢¼ ç²å–é»æ•¸</button> -->
            
            <h4>Event Features</h4>
            <a href="/votes/<%= eventId %>" class="btn btn-success mb-4">Participate in Voting</a>
            <a href="/events/<%= eventId %>/treasure-hunt/scan?userId=<%= user._id %>" class="btn btn-warning mb-4">ğŸ´â€â˜ ï¸ Treasure Hunt å°‹å¯¶éŠæˆ²</a>
            
            <!-- Lightbox -->
            <div class="lightbox" id="scannerLightbox">
                <div class="scanner-content" onclick="event.stopPropagation();">
                    <h3>æƒæ QR ç¢¼</h3>
                    <div id="reader" style="display: none;"></div>
                    <button id="closeScanner" class="btn btn-danger mt-2">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function() {
        const eventId = "<%= eventId %>";
        const currentUserId = "<%= user._id %>";
        let scanning = false;

        $('#qrcode').qrcode({
            text: `${eventId},${currentUserId}`,
            width: 128,
            height: 128
        });

        let html5QrCode = null;
        let currentAction = null;

        $('#loginQRCode').on('click', async function() {
            await stopScanner();
            $('#scannerLightbox').show();
            setTimeout(() => {
                startScanner('login');
            }, 100);
        });

        $('#scanPointQRCode').on('click', async function() {
            await stopScanner();
            $('#scannerLightbox').show();
            setTimeout(() => {
                startScanner('point');
            }, 100);
        });

        $('#closeScanner').on('click', async function(e) {
            e.stopPropagation();
            await stopScanner();
            $('#scannerLightbox').hide();
        });

        // ç•¶ lightbox èƒŒæ™¯è¢«é»æ“Šæ™‚ä¹Ÿåœæ­¢æƒæ
        $('#scannerLightbox').on('click', async function(e) {
            if (e.target === this) {
                await stopScanner();
                $(this).hide();
            }
        });

        async function startScanner(action) {
            // å¦‚æœå·²ç¶“åœ¨æƒæï¼Œå…ˆåœæ­¢
            if (scanning) {
                await stopScanner();
            }
            
            // ç¢ºä¿å…ˆåœæ­¢ä»»ä½•æ®˜ç•™çš„æƒæå™¨
            if (html5QrCode) {
                try {
                    scanning = false; // å…ˆè¨­ç½®æ¨™èªŒ
                    await html5QrCode.stop();
                    await html5QrCode.clear();
                } catch (e) {
                    // å¿½ç•¥éŒ¯èª¤
                }
                html5QrCode = null;
                currentAction = null;
            }
            
            // æ¸…ç©º reader div
            $('#reader').html('');
            
            try {
                // å‰µå»ºæ–°çš„æƒæå™¨å¯¦ä¾‹
                html5QrCode = new Html5Qrcode("reader");
                currentAction = action;
                $('#loginQRCode').prop('disabled', true);
                $('#reader').show();
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    async (decodedText, decodedResult) => {
                        // ç«‹å³è™•ç†ï¼Œé¿å…é‡è¤‡æƒæ
                        if (!scanning) return;
                        await handleQRCodeScan(decodedText, action);
                    },
                    (errorMessage) => {
                        // æƒæéŒ¯èª¤æ™‚ä¸é¡¯ç¤º
                    }
                );
                
                // å•Ÿå‹•å¾Œéš±è— canvasï¼Œåªé¡¯ç¤º video
                setTimeout(() => {
                    $('#reader canvas#qr-canvas').css('display', 'none');
                    $('#reader canvas').not('video').css('display', 'none');
                }, 200);
                
                scanning = true;
            } catch (error) {
                console.error('Error starting scanner:', error);
                scanning = false;
                html5QrCode = null;
                $('#loginQRCode').prop('disabled', false);
                $('#reader').html('');
                $('#reader').hide();
                
                if (error.message && (error.message.includes('already') || error.message.includes('Permission'))) {
                    alert('æƒæå™¨æ­£åœ¨ä½¿ç”¨ä¸­æˆ–æ¬Šé™å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦');
                } else {
                    alert('ç„¡æ³•å•Ÿå‹•æƒæå™¨ï¼š' + error.message);
                }
            }
        }

        async function stopScanner() {
            scanning = false;
            
            if (!html5QrCode) {
                $('#reader').html('');
                return;
            }
            
            try {
                await html5QrCode.stop();
            } catch (error) {
                console.log('Error stopping scanner:', error);
            } finally {
                try {
                    await html5QrCode.clear();
                } catch (e) {
                    // å¿½ç•¥
                }
                $('#reader').html('');
                html5QrCode = null;
                currentAction = null;
                $('#loginQRCode').prop('disabled', false);
                $('#reader').hide();
            }
        }

        async function handleQRCodeScan(decodedText, action) {
            if (!scanning) return;
            
            // ç«‹å³åœæ­¢æƒæå™¨
            scanning = false;
            await stopScanner();
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯ Treasure Hunt QR Codeï¼ˆæ ¼å¼ï¼štreasure:eventId:itemIdï¼‰
            if (decodedText.startsWith('treasure:')) {
                const parts = decodedText.split(':');
                if (parts.length === 3 && parts[1] === eventId) {
                    const scannedUserId = "<%= user._id %>";
                    // ç™¼é€ Treasure Hunt æƒæè«‹æ±‚
                    $.ajax({
                        url: `/events/${eventId}/treasure-hunt/scan`,
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ 
                            qrCodeData: decodedText,
                            userId: scannedUserId
                        }),
                        success: function(response) {
                            if (response.success) {
                                alert(response.message);
                                $('#scannerLightbox').hide();
                                location.reload(); // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°ç©åˆ†
                            } else {
                                alert(response.message || 'æƒæå¤±æ•—');
                            }
                        },
                        error: function(xhr) {
                            alert(xhr.responseJSON?.message || 'æƒæå¤±æ•—');
                        }
                    });
                    return;
                } else {
                    alert('ç„¡æ•ˆçš„ Treasure Hunt QR Code æˆ–äº‹ä»¶ ID ä¸åŒ¹é…');
                    return;
                }
            }
            
            // è™•ç†å…¶ä»–é¡å‹çš„ QR Codeï¼ˆåŸæœ‰é‚è¼¯ï¼‰
            const params = decodedText.split(','); // å‡è¨­ QR ç¢¼æ ¼å¼ç‚º eventId,userId æˆ– eventId,pointId
            const scannedEventId = params[0];

                if (action === 'login') {
                    const scannedUserId = "<%= user._id %>"; // ä½¿ç”¨ç•¶å‰é é¢çš„ç”¨æˆ¶ID

                    // æª¢æŸ¥æƒæçš„ eventId æ˜¯å¦èˆ‡ç•¶å‰ eventId åŒ¹é…
                    if (scannedEventId === eventId) {
                        // ç™¼é€ checkIn è«‹æ±‚
                        $.ajax({
                            url: `/events/${scannedEventId}/users/${scannedUserId}/checkin`,
                            method: 'PUT',
                            contentType: 'application/json',
                            success: function(response) {
                                alert(response.message);
                                $('#scannerLightbox').hide();
                                location.reload(); // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°ç‹€æ…‹
                            },
                            error: function(xhr) {
                                alert(xhr.responseJSON?.message || 'Check-in å¤±æ•—');
                            }
                        });
                    } else {
                        alert("æƒæçš„äº‹ä»¶ ID ä¸åŒ¹é…ï¼");
                    }
                } else if (action === 'point') {
                    const pointId = params[1]; // å‡è¨­ QR ç¢¼æ ¼å¼ç‚º eventId,pointId

                    // æª¢æŸ¥æƒæçš„ eventId æ˜¯å¦èˆ‡ç•¶å‰ eventId åŒ¹é…
                    if (scannedEventId === eventId) {
                        // ç™¼é€ç²å–é»æ•¸è«‹æ±‚
                        $.ajax({
                            url: `/events/${scannedEventId}/points/getPoint`,
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ pointId: pointId }),
                            success: function(response) {
                                alert(response.message);
                                $('#scannerLightbox').hide();
                                location.reload(); // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°ç©åˆ†
                            },
                            error: function(xhr) {
                                alert(xhr.responseJSON?.message || 'ç²å–é»æ•¸å¤±æ•—');
                            }
                        });
                    } else {
                        alert("æƒæçš„äº‹ä»¶ ID ä¸åŒ¹é…ï¼");
                    }
                }
        }
    });
</script>

</body>
</html>