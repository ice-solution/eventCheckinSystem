<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lucky Draw</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      height:100vh;
      overflow-y:scroll;
      overflow-x:hidden;
      margin: 0;
      /* background: rgb(0, 46, 93); */
    }
    .bg {
      position: relative; /* 為 #current 的絕對定位提供參考 */
      background-image: url('/luckydraw/img/<%= eventId %>.jpg'); /* 使用事件 ID 作為背景圖片 */
      background-size: cover; /* 使背景圖片覆蓋整個畫面 */
      background-position: center; /* 使背景圖片居中 */
      padding: 120px;
      height:100vh;
    }

    #result {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      gap: 10px;
      margin-top: 30px; /* 增加上邊距以向下移動 result */
      justify-content: center; /* 置中所有項目 */
      align-items: center; /* 垂直置中 */
    }

    .rets {
      display: flex;
      align-items: center; /* 垂直居中 */
      background-color: #ffeeba;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      transition: 0.3s;
      width: auto; /* 根據內容自動調整 */
      min-width: 200px; /* 最小寬度 */
      max-width: calc(25% - 10px); /* 最大寬度保持四個一行，但允許更長 */
      flex: 0 1 auto; /* 根據內容自動調整 */
    }

    .rets:hover {
      background-color: #ffe08a;
    }

    .number {
      width: 30px; /* 控制序號的寬度 */
      text-align: center;
      font-weight: bold;
      font-size: 20.8px; /* 16px * 1.3 = 20.8px (加大 30%) */
      margin-right: 10px; /* 與卡片內容的間距 */
    }

    .card {
      flex-grow: 1; /* 使卡片佔滿剩餘空間 */
    }

    .name {
      font-weight: bold;
      font-size: 25px;
      white-space: nowrap; /* 防止換行 */
      overflow: visible; /* 允許溢出顯示 */
      word-break: keep-all; /* 保持單詞完整 */
    }

    .company {
      font-size: 20px;
      color: #555;
      margin-top: 3px;
    }

    .table {
      font-size: 15.6px; /* 12px * 1.3 = 15.6px (加大 30%) */
      color: #666;
      margin-top: 2px;
    }

    .prize {
      font-size: 24px;
      font-weight: bold;
      color: #e74c3c;
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 4px;
      padding: 8px 16px;
      margin-bottom: 10px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #ccc;
      border-top: 6px solid #28a745;
      border-radius: 50%;
      animation: spin 0.4s linear infinite;
      display: none;
      margin: 0 auto;
    }

    .current-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin-top: 150px;
    }
    
    #current {
      display: none; /* 初始隱藏 */
      width: auto; /* 根據內容自動調整寬度 */
      min-width: 300px; /* 最小寬度 */
      max-width: 95%; /* 最大寬度不超過視窗 */
      text-align: center; /* 確保內容置中 */
      justify-content: center; /* flex 置中 */
    }
    
    #current .rets {
      display: flex;
      align-items: center; /* 垂直居中 */
      background-color: #ffeeba;
      border-radius: 9px; /* 6px * 1.5 = 9px (再放大 50%) */
      padding: 23.4px; /* 15.6px * 1.5 = 23.4px (再放大 50%) */
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      transition: 0.3s;
      width: auto; /* 根據內容自動調整 */
      min-width: fit-content; /* 適應內容寬度 */
      justify-content: center; /* 水平置中 */
    }
    
    #current .number {
      width: 58.5px; /* 39px * 1.5 = 58.5px (再放大 50%) */
      flex-shrink: 0; /* 不允許縮小 */
      text-align: center;
      font-weight: bold;
      font-size: 31.2px; /* 20.8px * 1.5 = 31.2px (再放大 50%) */
      margin-right: 19.5px; /* 13px * 1.5 = 19.5px (再放大 50%) */
    }
    
    #current .card {
      flex: 0 1 auto; /* 根據內容自動調整，不強制增長 */
      min-width: 0; /* 允許 flex 項目縮小 */
      overflow: visible; /* 允許內容顯示，不隱藏溢出 */
    }
    
    #current .name {
      font-weight: bold;
      font-size: 37.5px; /* 25px * 1.5 = 37.5px (再放大 50%) */
      white-space: nowrap; /* 防止換行 */
      word-break: keep-all; /* 保持單詞完整 */
      overflow: visible; /* 允許溢出顯示 */
    }
    
    #current .company {
      font-size: 30px; /* 20px * 1.5 = 30px (再放大 50%) */
      color: #555;
      margin-top: 4.5px; /* 3px * 1.5 = 4.5px (再放大 50%) */
      white-space: nowrap; /* 防止換行 */
    }
    
    #current .table {
      font-size: 23.4px; /* 15.6px * 1.5 = 23.4px (再放大 50%) */
      color: #666;
      margin-top: 3px; /* 2px * 1.5 = 3px (再放大 50%) */
      white-space: nowrap; /* 防止換行 */
    }

    h1 {
      color: #000;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .animation {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 999;
    }

    .spinner {
      width: 150px; /* 調整為新的 giftbox.gif 尺寸 */
      height: 150px; /* 調整為新的 giftbox.gif 尺寸 */
      /* 移除 CSS 旋轉動畫，因為 giftbox.gif 本身已有動畫 */
    }

    /* 移除 CSS 旋轉動畫，因為 giftbox.gif 本身已有動畫 */

    /* Start Button 樣式 */
    #startButton {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      cursor: pointer;
      transition: opacity 0.3s ease-in-out;
    }

    #startButton.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #startButton img {
      width: auto;
      height: auto;
      max-width: 300px;
      max-height: 300px;
    }
  </style>
  <!-- <link rel="stylesheet" href="/admin/assets/css/luckydraw.css"> -->
</head>
<body>

  <div class="bg">
    <!-- Start Button -->
    <div id="startButton">
      <img src="/admin/img/11.png" alt="Start Draw" id="startButtonImage">
    </div>

    <!-- 燈號狀態（右上角） -->
    <div id="controllerStatus" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      <div id="statusIndicator" style="display: inline-block; width: 20px; height: 20px; border-radius: 50%; background-color: #dc3545;"></div>
    </div>

    <!-- 抽獎狀態和獎品顯示（中央上方） -->
    <div id="drawingStatus" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255, 255, 255, 0.95); padding: 20px 40px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; font-size: 24px; font-weight: bold; color: #333; display: none;">
      <div id="statusText" style="margin-bottom: 10px;">Draw Now</div>
      <img id="prizeImage" src="" alt="" style="max-width: 120px; max-height: 90px; border-radius: 8px; margin-bottom: 8px; display: none;">
      <div id="prizeText" style="font-size: 20px; color: #e74c3c;"></div>
    </div>
    <div class="js-container container" style="display: flex; justify-content: center; align-items: center; width: 100%;">
      <div id="result"></div>
    </div>

    <div class="current-container">
      <div id="current"></div>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="animation" id="animation">
      <img src="/admin/img/giftbox.gif" alt="Loading..." class="spinner" id="spinnerImage">
    </div>
  </div> 

  <script>
    const eventId = '<%= eventId %>';
    const resultDiv = document.getElementById('result');
    const currentDiv = document.getElementById('current');
    const overlay = document.getElementById('overlay');
    const animationDiv = document.getElementById('animation');

    const socket = io();
    socket.emit('join_luckydraw', { eventId, type: 'display' });

    const controllerStatusDiv = document.getElementById('controllerStatus');
    const statusIndicator = document.getElementById('statusIndicator');
    const drawingStatusDiv = document.getElementById('drawingStatus');
    const statusTextDiv = document.getElementById('statusText');
    const prizeTextDiv = document.getElementById('prizeText');
    const prizeImageEl = document.getElementById('prizeImage');
    let controllerConnected = false;
    let currentPrizeName = null;
    let currentPrizePicture = null;

    function updateStatusDisplay() {
      // 更新燈號（右上角）
      controllerStatusDiv.style.display = 'block';
      if (!controllerConnected) {
        // 紅色燈（未連接）
        statusIndicator.style.backgroundColor = '#dc3545';
        drawingStatusDiv.style.display = 'none';
      } else {
        // 綠色燈（已連接）
        statusIndicator.style.backgroundColor = '#28a745';
        
        // 更新抽獎狀態顯示（中央上方），含獎品名稱與圖片
        if (currentPrizeName) {
          drawingStatusDiv.style.display = 'block';
          statusTextDiv.textContent = 'Draw Now';
          prizeTextDiv.textContent = currentPrizeName;
          if (currentPrizePicture && currentPrizePicture.trim() !== '') {
            prizeImageEl.src = currentPrizePicture;
            prizeImageEl.alt = currentPrizeName;
            prizeImageEl.style.display = 'block';
          } else {
            prizeImageEl.style.display = 'none';
            prizeImageEl.removeAttribute('src');
          }
        } else {
          drawingStatusDiv.style.display = 'none';
          prizeImageEl.style.display = 'none';
        }
      }
    }

    // 初始化顯示
    updateStatusDisplay();

    // 監聽控制器連接狀態
    socket.on('luckydraw:controller_status', ({ status }) => {
      controllerConnected = (status === 'online');
      if (!controllerConnected) {
        currentPrizeName = null;
        currentPrizePicture = null;
      }
      updateStatusDisplay();
    });

    // 監聽獎品選擇（含獎品圖片 URL，只接 prizeImage）
    socket.on('luckydraw:prize_selected', ({ prizeName, prizeImage }) => {
      currentPrizeName = prizeName;
      currentPrizePicture = prizeImage || null;
      updateStatusDisplay();
    });

    let winners = [];
    let currentDrawWinners = []; // 追蹤當前抽獎輪次的中獎者
    let currentDrawTimer = null; // 用於延遲顯示，判斷是單抽還是批量抽
    let isCurrentDrawSingle = null; // null=未確定, true=單抽, false=批量抽

    // 將中獎者添加到全局 winners 數組（用於追蹤所有中獎者）
    function addWinnerToGlobalList(winner) {
      const winnerId = String(winner._id);
      const existsIndex = winners.findIndex(w => String(w._id) === winnerId);
      
      if (existsIndex === -1) {
        winners.push(winner);
      } else {
        winners[existsIndex] = winner;
      }
    }
    
    // 單獨的函數用於渲染單抽結果到中間（格式與 #result 一致）
    function renderSingleWinnerToCenter(winner) {
      const userName = winner.name || 'Unknown';
      const orderNumber = winner.order || '';
      
      // 使用與 #result 一致的格式，抽獎編號在左邊；若有獎品圖片則顯示
      let displayContent = '';
      const winnerImg = (winner.prizeImage || '').trim();
      if (winnerImg) {
        displayContent += `<div class="winner-prize-img" style="margin-bottom:8px;"><img src="${winnerImg}" alt="${(winner.prizeName || '').replace(/"/g, '&quot;')}" style="max-width:80px;max-height:60px;border-radius:6px;"></div>`;
      }
      displayContent += `<div class="name">${userName}</div>`;
      if (winner.company) {
        displayContent += `<div class="company">${winner.company}</div>`;
      }
      if (winner.table) {
        displayContent += `<div class="table">Table: ${winner.table}</div>`;
      }
      
      currentDiv.innerHTML = `<div class="rets"><div class="number">${orderNumber}</div><div class="card">${displayContent}</div></div>`;
      currentDiv.style.display = 'flex'; // 使用 flex 以確保置中
      currentDiv.style.justifyContent = 'center';
      resultDiv.innerHTML = ''; // 清除列表
      
      // 動態調整 #current 寬度以適應內容
      setTimeout(() => {
        const retsElement = currentDiv.querySelector('.rets');
        if (retsElement) {
          const contentWidth = retsElement.scrollWidth;
          const viewportWidth = window.innerWidth;
          // 設置寬度為內容寬度，但不超過視窗的 95%
          const maxWidth = Math.min(contentWidth + 50, viewportWidth * 0.95);
          retsElement.style.width = 'auto';
          retsElement.style.minWidth = Math.max(contentWidth, 300) + 'px';
        }
      }, 10);
    }
    
    // 單獨的函數用於渲染批量抽結果到列表
    function renderBatchWinnersToList(winnersToRender) {
      currentDiv.style.display = 'none';
      currentDiv.innerHTML = '';
      resultDiv.innerHTML = ''; // 先清空列表
      
      // 確保 resultDiv 使用 flex 布局並置中
      resultDiv.style.display = 'flex';
      resultDiv.style.justifyContent = 'center';
      resultDiv.style.alignItems = 'center';
      resultDiv.style.flexWrap = 'wrap';
      resultDiv.style.gap = '10px';
      
      winnersToRender.forEach((winner) => {
        const winnerId = String(winner._id);
        const rets = document.createElement('div');
        rets.className = 'rets';
        rets.dataset.id = winnerId;
        
        let displayContent = '';
        const winnerImg = (winner.prizeImage || '').trim();
        if (winnerImg) {
          displayContent += `<div class="winner-prize-img" style="margin-bottom:6px;"><img src="${winnerImg}" alt="${(winner.prizeName || '').replace(/"/g, '&quot;')}" style="max-width:60px;max-height:45px;border-radius:6px;"></div>`;
        }
        const userName = winner.name || 'Unknown';
        displayContent += `<div class="name">${userName}</div>`;
        if (winner.company) {
          displayContent += `<div class="company">${winner.company}</div>`;
        }
        if (winner.table) {
          displayContent += `<div class="table">Table: ${winner.table}</div>`;
        }
        
        const orderNumber = winner.order;
        if (!orderNumber) {
          console.warn('Winner missing order:', winner);
        }
        rets.innerHTML = `<div class="number">${orderNumber || ''}</div><div class="card">${displayContent}</div>`;
        resultDiv.appendChild(rets);
      });
    }

    function removeWinnerFromView(winnerId) {
      winners = winners.filter(w => String(w._id) !== String(winnerId));
      const node = resultDiv.querySelector(`.rets[data-id="${winnerId}"]`);
      if (node) {
        resultDiv.removeChild(node);
      }
      // 注意：不需要重新計算數字，因為使用的是中獎編號（order），刪除後不會重用
    }

    let animationTimer = null;
    let animationStartTime = null;

    socket.on('luckydraw:start', () => {
      overlay.style.display = 'block';
      animationDiv.style.display = 'block';
      animationStartTime = Date.now();
      
      // 清除之前的显示和状态
      currentDiv.style.display = 'none';
      currentDiv.innerHTML = '';
      resultDiv.innerHTML = '';
      currentDrawWinners = [];
      isCurrentDrawSingle = null;
      
      // 清除之前的定时器
      if (animationTimer) clearTimeout(animationTimer);
      if (currentDrawTimer) clearTimeout(currentDrawTimer);
      
      // 动画持续 3 秒
      animationTimer = setTimeout(() => {
        overlay.style.display = 'none';
        animationDiv.style.display = 'none';
        animationStartTime = null;
      }, 3000);
    });

    socket.on('luckydraw:winner_added', ({ winner }) => {
      console.log('Received winner_added event:', winner);
      
      // 添加到當前抽獎輪次
      currentDrawWinners.push(winner);
      
      // 清除之前的定時器
      if (currentDrawTimer) clearTimeout(currentDrawTimer);
      
      // 等待一小段時間（500ms）來判斷是單抽還是批量抽
      currentDrawTimer = setTimeout(() => {
        // 先將所有中獎者添加到全局列表
        currentDrawWinners.forEach(winner => {
          addWinnerToGlobalList(winner);
        });
        
        // 判斷是單抽（1個）還是批量抽（多個）
        isCurrentDrawSingle = (currentDrawWinners.length === 1);
        
        // 渲染所有當前抽獎的中獎者
        if (isCurrentDrawSingle) {
          // 單抽：只顯示中間，不顯示列表
          renderSingleWinnerToCenter(currentDrawWinners[0]);
        } else {
          // 批量抽：顯示列表，不顯示中間
          renderBatchWinnersToList(currentDrawWinners);
        }
        
        // 重置狀態，準備下一次抽獎
        currentDrawWinners = [];
        isCurrentDrawSingle = null;
      }, 500);
      
      // 如果动画正在播放，等待动画结束
      if (animationDiv.style.display === 'block' && animationStartTime) {
        const elapsed = Date.now() - animationStartTime;
        const remaining = Math.max(0, 3000 - elapsed);
        // 延遲執行渲染，但渲染邏輯會根據 currentDrawWinners 數量判斷
        setTimeout(() => {
          overlay.style.display = 'none';
          animationDiv.style.display = 'none';
          animationStartTime = null;
        }, remaining);
      }
    });

    socket.on('luckydraw:winner_removed', ({ winnerId }) => {
      removeWinnerFromView(winnerId);
    });

    // 監聽所有中獎者被清除的事件
    socket.on('luckydraw:all_winners_removed', () => {
      // 清除所有顯示
      resultDiv.innerHTML = '';
      currentDiv.innerHTML = '';
      currentDiv.style.display = 'none';
      winners = [];
      currentDrawWinners = [];
      isCurrentDrawSingle = null;
    });

    // Start Button 功能
    const startButton = document.getElementById('startButton');
    let hasStarted = false;

    function hideStartButton() {
      if (startButton && !hasStarted) {
        startButton.classList.add('hidden');
        hasStarted = true;
      }
    }

    // 監聽抽獎開始事件，隱藏 start button
    socket.on('luckydraw:start', () => {
      hideStartButton();
    });

    // 點擊 start button 時通知控制器頁面開始抽獎
    if (startButton) {
      startButton.addEventListener('click', () => {
        socket.emit('luckydraw:user_start_click', { eventId });
        hideStartButton();
      });
    }

    // 如果有中獎者，隱藏 start button
    socket.on('luckydraw:winner_added', ({ winner }) => {
      hideStartButton();
    });
  </script>
  <!-- <script src="/admin/assets/js/luckydraw.js"></script> -->
</body>
</html>
