<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>äº’å‹•æŠ½ç</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      height:100vh;
      overflow-y:scroll;
      overflow-x:hidden;
      margin: 0;
      /* background: rgb(0, 46, 93); */
    }
    .bg {
      background-image: url('/luckydraw/img/<%= eventId %>.jpg'); /* ä½¿ç”¨äº‹ä»¶ ID ä½œç‚ºèƒŒæ™¯åœ–ç‰‡ */
      background-size: cover; /* ä½¿èƒŒæ™¯åœ–ç‰‡è¦†è“‹æ•´å€‹ç•«é¢ */
      background-position: center; /* ä½¿èƒŒæ™¯åœ–ç‰‡å±…ä¸­ */
      padding: 120px;
      height:100vh;
    }

    #result {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      gap: 10px;
      margin-top: 30px; /* å¢åŠ ä¸Šé‚Šè·ä»¥å‘ä¸‹ç§»å‹• result */
    }

    .rets {
      display: flex;
      align-items: center; /* å‚ç›´å±…ä¸­ */
      background-color: #ffeeba;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      transition: 0.3s;
      width: calc(25% - 10px); /* ä½¿å…¶ä½”æ»¿çˆ¶å®¹å™¨ï¼Œå››å€‹ä¸€è¡Œ */
    }

    .rets:hover {
      background-color: #ffe08a;
    }

    .number {
      width: 30px; /* æ§åˆ¶åºè™Ÿçš„å¯¬åº¦ */
      text-align: center;
      font-weight: bold;
      margin-right: 10px; /* èˆ‡å¡ç‰‡å…§å®¹çš„é–“è· */
    }

    .card {
      flex-grow: 1; /* ä½¿å¡ç‰‡ä½”æ»¿å‰©é¤˜ç©ºé–“ */
    }

    .name {
      font-weight: bold;
      font-size: 16px;
    }

    .company {
      font-size: 13px;
      color: #555;
      margin-top: 3px;
    }

    .table {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .prize {
      font-size: 24px;
      font-weight: bold;
      color: #e74c3c;
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 4px;
      padding: 8px 16px;
      margin-bottom: 10px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #ccc;
      border-top: 6px solid #28a745;
      border-radius: 50%;
      animation: spin 0.4s linear infinite;
      display: none;
      margin: 0 auto;
    }

    #current {
      font-size: 36px;
      font-weight: bold;
      color: black; /* æ–‡å­—é¡è‰²è¨­ç½®ç‚ºé»‘è‰² */
      text-align: center;
      margin-top: 150px;
      background-color: #ffeeba; /* èˆ‡ card ä¸€è‡´çš„èƒŒæ™¯ */
      border-radius: 6px; /* èˆ‡ card ä¸€è‡´çš„åœ“è§’ */
      padding: 50px; /* èˆ‡ card ä¸€è‡´çš„å…§é‚Šè· */
      width: 20%; /* èª¿æ•´å¯¬åº¦ */
      margin-left: auto; /* å±…ä¸­ */
      margin-right: auto; /* å±…ä¸­ */
      display: none; /* åˆå§‹éš±è— */
    }

    h1 {
      color: #000;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .animation {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 999;
    }

    .spinner {
      width: 150px; /* èª¿æ•´ç‚ºæ–°çš„ giftbox.gif å°ºå¯¸ */
      height: 150px; /* èª¿æ•´ç‚ºæ–°çš„ giftbox.gif å°ºå¯¸ */
      /* ç§»é™¤ CSS æ—‹è½‰å‹•ç•«ï¼Œå› ç‚º giftbox.gif æœ¬èº«å·²æœ‰å‹•ç•« */
    }

    /* ç§»é™¤ CSS æ—‹è½‰å‹•ç•«ï¼Œå› ç‚º giftbox.gif æœ¬èº«å·²æœ‰å‹•ç•« */
  </style>
  <!-- <link rel="stylesheet" href="/admin/assets/css/luckydraw.css"> -->
</head>
<body>

  <div class="bg">
    <!-- æ§åˆ¶å™¨ç‹€æ…‹å’Œçå“é¡¯ç¤º -->
    <div id="controllerStatus" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255, 255, 255, 0.95); padding: 20px 40px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; font-size: 24px; font-weight: bold; color: #333;">
      <div id="statusText">ç­‰å¾…æ§åˆ¶å™¨é€£ç·š</div>
      <div id="prizeText" style="margin-top: 10px; font-size: 20px; color: #e74c3c; display: none;"></div>
    </div>
    <div class="js-container  container">
      <div id="result"></div>
    </div>

    <div id="current"></div>
    <div class="overlay" id="overlay"></div>
    <div class="animation" id="animation">
      <img src="/admin/img/giftbox.gif" alt="Loading..." class="spinner" id="spinnerImage">
    </div>
  </div> 

  <script>
    const eventId = '<%= eventId %>';
    const resultDiv = document.getElementById('result');
    const currentDiv = document.getElementById('current');
    const overlay = document.getElementById('overlay');
    const animationDiv = document.getElementById('animation');

    const socket = io();
    socket.emit('join_luckydraw', { eventId });

    const controllerStatusDiv = document.getElementById('controllerStatus');
    const statusTextDiv = document.getElementById('statusText');
    const prizeTextDiv = document.getElementById('prizeText');
    let controllerConnected = false;
    let currentPrizeName = null;

    function updateStatusDisplay() {
      if (!controllerConnected) {
        controllerStatusDiv.style.display = 'block';
        statusTextDiv.textContent = 'ç­‰å¾…æ§åˆ¶å™¨é€£ç·š';
        prizeTextDiv.style.display = 'none';
      } else if (currentPrizeName) {
        controllerStatusDiv.style.display = 'block';
        statusTextDiv.textContent = 'ç¾åœ¨æŠ½ç';
        prizeTextDiv.textContent = `: ${currentPrizeName}`;
        prizeTextDiv.style.display = 'block';
      } else {
        // æ§åˆ¶å™¨å·²é€£æ¥ä½†é‚„æ²’é¸æ“‡çå“ï¼Œéš±è—ç‹€æ…‹é¡¯ç¤º
        controllerStatusDiv.style.display = 'none';
      }
    }

    // åˆå§‹åŒ–é¡¯ç¤º
    updateStatusDisplay();

    // ç›£è½æ§åˆ¶å™¨é€£æ¥ç‹€æ…‹
    socket.on('luckydraw:controller_status', ({ status }) => {
      controllerConnected = (status === 'online');
      if (!controllerConnected) {
        currentPrizeName = null;
      }
      updateStatusDisplay();
    });

    // ç›£è½çå“é¸æ“‡
    socket.on('luckydraw:prize_selected', ({ prizeName }) => {
      currentPrizeName = prizeName;
      updateStatusDisplay();
    });

    let winners = [];

    function renderWinner(winner) {
      // ç¢ºä¿ winner å°è±¡æœ‰å¿…è¦çš„å­—æ®µ
      if (!winner || !winner._id) {
        console.error('Invalid winner object:', winner);
        return;
      }

      console.log('Rendering winner:', winner);

      const winnerId = String(winner._id);
      const existsIndex = winners.findIndex(w => String(w._id) === winnerId);
      
      // æª¢æŸ¥ DOM ä¸­æ˜¯å¦å·²å­˜åœ¨è©²å…ƒç´ 
      const existingElement = resultDiv.querySelector(`.rets[data-id="${winnerId}"]`);
      
      if (existsIndex === -1) {
        winners.push(winner);
      } else {
        winners[existsIndex] = winner;
      }

      // å¦‚æœå…ƒç´ å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
      if (existingElement) {
        resultDiv.removeChild(existingElement);
      }

      const rets = document.createElement('div');
      rets.className = 'rets';
      rets.dataset.id = winnerId;

      // è¨ˆç®—æ­£ç¢ºçš„åºè™Ÿï¼ˆåœ¨ winners æ•¸çµ„ä¸­çš„ä½ç½® + 1ï¼‰
      const number = existsIndex === -1 ? winners.length : existsIndex + 1;
      let displayContent = '';

      if (winner.prizeName) {
        displayContent += `<div class="prize">ğŸ ${winner.prizeName}</div>`;
      }
      if (winner.company) {
        displayContent += `<div class="company">${winner.company}</div>`;
      }
      if (winner.table) {
        displayContent += `<div class="table">æ¡Œè™Ÿ: ${winner.table}</div>`;
      }
      // ç¢ºä¿ç”¨æˆ¶åä¸€å®šæœƒé¡¯ç¤º
      const userName = winner.name || 'æœªçŸ¥';
      displayContent += `<div class="name">${userName}</div>`;

      rets.innerHTML = `<div class="number">${number}</div><div class="card">${displayContent}</div>`;
      resultDiv.appendChild(rets);

      // æ›´æ–°æ‰€æœ‰å…ƒç´ çš„åºè™Ÿ
      Array.from(resultDiv.querySelectorAll('.rets')).forEach((el, idx) => {
        const numberDiv = el.querySelector('.number');
        if (numberDiv) numberDiv.textContent = idx + 1;
      });

      let currentDisplay = '';
      if (winner.prizeName) {
        currentDisplay += `<div style="font-size: 24px; color: #e74c3c; font-weight: bold; margin-bottom: 10px;">ğŸ ${winner.prizeName}</div>`;
      }
      if (winner.company) {
        currentDisplay += `<div style="font-size: 18px; font-weight: bold;">${winner.company}</div>`;
      }
      if (winner.table) {
        currentDisplay += `<div style="font-size: 16px;">æ¡Œè™Ÿ: ${winner.table}</div>`;
      }
      currentDisplay += `<div style="font-size: 16px;">${userName}</div>`;
      currentDiv.innerHTML = currentDisplay;
      currentDiv.style.display = 'block';
    }

    function removeWinnerFromView(winnerId) {
      winners = winners.filter(w => String(w._id) !== String(winnerId));
      const node = resultDiv.querySelector(`.rets[data-id="${winnerId}"]`);
      if (node) {
        resultDiv.removeChild(node);
      }
      Array.from(resultDiv.querySelectorAll('.rets')).forEach((el, idx) => {
        const numberDiv = el.querySelector('.number');
        if (numberDiv) numberDiv.textContent = idx + 1;
      });
    }

    let animationTimer = null;
    let animationStartTime = null;

    socket.on('luckydraw:start', () => {
      overlay.style.display = 'block';
      animationDiv.style.display = 'block';
      animationStartTime = Date.now();
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (animationTimer) clearTimeout(animationTimer);
      // åŠ¨ç”»æŒç»­ 3 ç§’
      animationTimer = setTimeout(() => {
        overlay.style.display = 'none';
        animationDiv.style.display = 'none';
        animationStartTime = null;
      }, 3000);
    });

    socket.on('luckydraw:winner_added', ({ winner }) => {
      console.log('Received winner_added event:', winner);
      // å¦‚æœåŠ¨ç”»æ­£åœ¨æ’­æ”¾ï¼Œç­‰å¾…åŠ¨ç”»ç»“æŸï¼›å¦åˆ™ç«‹å³æ˜¾ç¤º
      if (animationDiv.style.display === 'block' && animationStartTime) {
        const elapsed = Date.now() - animationStartTime;
        const remaining = Math.max(0, 3000 - elapsed);
        setTimeout(() => {
          overlay.style.display = 'none';
          animationDiv.style.display = 'none';
          animationStartTime = null;
          renderWinner(winner);
        }, remaining);
      } else {
        // æ²¡æœ‰åŠ¨ç”»åœ¨æ’­æ”¾ï¼Œç«‹å³æ˜¾ç¤º
        renderWinner(winner);
      }
    });

    socket.on('luckydraw:winner_removed', ({ winnerId }) => {
      removeWinnerFromView(winnerId);
    });
  </script>
  <!-- <script src="/admin/assets/js/luckydraw.js"></script> -->
</body>
</html>
