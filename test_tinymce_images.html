<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyMCE åœ–ç‰‡ URL æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .url-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        .btn:hover {
            background-color: #0056b3;
        }
    </style>
    <script src="https://cdn.tiny.cloud/1/0o0ixrpieipnq3fsu3kbsdu9e627qg468y6lpup3gmhx8lz7/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <h1>TinyMCE åœ–ç‰‡ URL æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>1. TinyMCE ç·¨è¼¯å™¨</h2>
        <p>åœ¨ç·¨è¼¯å™¨ä¸­æ’å…¥åœ–ç‰‡ï¼Œç„¶å¾Œæª¢æŸ¥ URL æ˜¯å¦ç‚ºå®Œæ•´çš„çµ•å°è·¯å¾‘ï¼š</p>
        <textarea id="content" rows="10" style="width: 100%;"></textarea>
    </div>
    
    <div class="test-section">
        <h2>2. æ¸¬è©¦æŒ‰éˆ•</h2>
        <button class="btn" onclick="insertBannerImage()">æ’å…¥ Banner åœ–ç‰‡</button>
        <button class="btn" onclick="insertQRCodeImage()">æ’å…¥ QR Code åœ–ç‰‡</button>
        <button class="btn" onclick="insertUploadedImage()">æ’å…¥ä¸Šå‚³çš„åœ–ç‰‡</button>
        <button class="btn" onclick="getContent()">ç²å–å…§å®¹</button>
        <button class="btn" onclick="checkImageUrls()">æª¢æŸ¥åœ–ç‰‡ URL</button>
    </div>
    
    <div class="test-section">
        <h2>3. å…§å®¹é¡¯ç¤º</h2>
        <div id="contentDisplay"></div>
    </div>
    
    <div class="test-section">
        <h2>4. åœ–ç‰‡ URL åˆ†æ</h2>
        <div id="urlAnalysis"></div>
    </div>

    <script>
        tinymce.init({
            selector: '#content',
            plugins: 'image code link',
            toolbar: 'undo redo | fontselect | styleselect | bold italic | alignleft aligncenter alignright | image link | code',
            font_formats: 'æ¨™æ¥·é«”=DFKai-SB,BiauKai,AR PL UKai TW;å¾®è»Ÿæ­£é»‘é«”=Microsoft JhengHei,å¾®è»Ÿæ­£é»‘é«”;æ–°ç´°æ˜é«”=PMingLiU,æ–°ç´°æ˜é«”;ç´°æ˜é«”=MingLiU,ç´°æ˜é«”;Arial=arial,helvetica,sans-serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings,zapf dingbats',
            font_family_formats: 'æ¨™æ¥·é«”=DFKai-SB,BiauKai,AR PL UKai TW;å¾®è»Ÿæ­£é»‘é«”=Microsoft JhengHei,å¾®è»Ÿæ­£é»‘é«”;æ–°ç´°æ˜é«”=PMingLiU,æ–°ç´°æ˜é«”;ç´°æ˜é«”=MingLiU,ç´°æ˜é«”;Arial=arial,helvetica,sans-serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings,zapf dingbats',
            content_css: '/admin/assets/css/tinymce-custom-fonts.css',
            content_style: 'body { font-family: Arial, sans-serif; } * { font-family: inherit; }',
            images_upload_url: '/emailTemplate/upload',
            automatic_uploads: true,
            convert_urls: true,
            relative_urls: false,
            remove_script_host: false,
            document_base_url: window.location.origin,
            file_picker_types: 'image',
            file_picker_callback: function (callback, value, meta) {
                if (meta.filetype === 'image') {
                    var input = document.createElement('input');
                    input.setAttribute('type', 'file');
                    input.setAttribute('accept', 'image/*');
                    input.onchange = function () {
                        var file = this.files[0];
                        var reader = new FileReader();
                        reader.onload = function () {
                            callback(reader.result, { alt: file.name });
                        };
                        reader.readAsDataURL(file);
                    };
                    input.click();
                }
            },
            image_advtab: true,
            image_dimensions: true,
            image_class_list: [
                {title: 'Responsive', value: 'img-fluid'}
            ],
            urlconverter_callback: function(url, node, on_save, name) {
                console.log('URL Converter called:', url);
                // æª¢æŸ¥æ˜¯å¦ç‚º banner ç›¸é—œçš„åœ–ç‰‡
                if (url && (url.includes('banner') || url.includes('exvent'))) {
                    console.log('Banner image detected, converting to absolute URL');
                    // å° banner åœ–ç‰‡ä½¿ç”¨çµ•å° URL
                    if (url.indexOf('http') !== 0 && url.indexOf('//') !== 0) {
                        if (url.indexOf('/') === 0) {
                            return window.location.origin + url;
                        } else {
                            return window.location.origin + '/' + url;
                        }
                    }
                } else {
                    console.log('Non-banner image, keeping relative URL');
                }
                // å…¶ä»–åœ–ç‰‡ï¼ˆå¦‚ QR codeï¼‰ä¿æŒç›¸å°è·¯å¾‘
                return url;
            }
        });
        
        function insertBannerImage() {
            const bannerImageUrl = '/exvent/banner.jpg';
            tinymce.get('content').insertContent(`<img src="${bannerImageUrl}" alt="Banner åœ–ç‰‡" style="max-width: 300px;">`);
        }
        
        function insertQRCodeImage() {
            const qrCodeUrl = '/events/123/points/456'; // æ¨¡æ“¬ QR code è·¯å¾‘
            tinymce.get('content').insertContent(`<img src="${qrCodeUrl}" alt="QR Code" style="max-width: 200px;">`);
        }
        
        function insertUploadedImage() {
            const uploadedImageUrl = '/uploads/email_template_images/test.jpg';
            tinymce.get('content').insertContent(`<img src="${uploadedImageUrl}" alt="ä¸Šå‚³çš„åœ–ç‰‡" style="max-width: 300px;">`);
        }
        
        function getContent() {
            const content = tinymce.get('content').getContent();
            document.getElementById('contentDisplay').innerHTML = content;
        }
        
        function checkImageUrls() {
            const content = tinymce.get('content').getContent();
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const images = doc.querySelectorAll('img');
            
            let analysis = '<h3>åœ–ç‰‡ URL åˆ†æçµæœï¼š</h3>';
            
            images.forEach((img, index) => {
                const src = img.getAttribute('src');
                const isAbsolute = src && (src.startsWith('http://') || src.startsWith('https://') || src.startsWith('//'));
                const isRelative = src && src.startsWith('/');
                const isBanner = src && (src.includes('banner') || src.includes('exvent'));
                const isQRCode = src && src.includes('points');
                const isUploaded = src && src.includes('uploads');
                
                let imageType = 'å…¶ä»–';
                let shouldConvert = false;
                
                if (isBanner) {
                    imageType = 'Banner åœ–ç‰‡';
                    shouldConvert = true;
                } else if (isQRCode) {
                    imageType = 'QR Code åœ–ç‰‡';
                    shouldConvert = false;
                } else if (isUploaded) {
                    imageType = 'ä¸Šå‚³çš„åœ–ç‰‡';
                    shouldConvert = false;
                }
                
                analysis += `<div class="url-display">
                    <strong>åœ–ç‰‡ ${index + 1}:</strong><br>
                    <strong>URL:</strong> ${src}<br>
                    <strong>é¡å‹:</strong> ${imageType}<br>
                    <strong>è·¯å¾‘é¡å‹:</strong> ${isAbsolute ? 'çµ•å°è·¯å¾‘' : isRelative ? 'ç›¸å°è·¯å¾‘' : 'å…¶ä»–'}<br>
                    <strong>è½‰æ›ç­–ç•¥:</strong> <span style="color: ${shouldConvert ? 'blue' : 'green'}">${shouldConvert ? 'ğŸ”„ è½‰æ›ç‚ºçµ•å° URL' : 'ğŸ“Œ ä¿æŒç›¸å°è·¯å¾‘'}</span><br>
                    <strong>ç‹€æ…‹:</strong> <span style="color: ${isAbsolute ? 'green' : shouldConvert ? 'orange' : 'green'}">${isAbsolute ? 'âœ… å®Œæ•´ URL' : shouldConvert ? 'âš ï¸ éœ€è¦è½‰æ›' : 'âœ… ç›¸å°è·¯å¾‘ï¼ˆæ­£ç¢ºï¼‰'}</span>
                </div>`;
            });
            
            if (images.length === 0) {
                analysis += '<p>æ²’æœ‰æ‰¾åˆ°åœ–ç‰‡</p>';
            }
            
            document.getElementById('urlAnalysis').innerHTML = analysis;
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('TinyMCE æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ç•¶å‰åŸŸå:', window.location.origin);
        });
    </script>
</body>
</html>
